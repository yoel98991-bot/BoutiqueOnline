<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <title>Tienda</title>
    
    <link rel="manifest" id="my-manifest-placeholder">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- ESTILOS BASE & GLASSMORPHISM --- */
        :root { 
            --text-main: #1e293b; 
            --text-light: #64748b;
            --accent: #4f46e5; 
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            --blur: blur(12px);
            --radius: 16px; 
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            color: var(--text-main); 
            /* Fondo degradado para resaltar el efecto cristal */
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            background-attachment: fixed;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Elementos decorativos de fondo (Blobs) */
        .bg-blob {
            position: fixed; border-radius: 50%; filter: blur(60px); z-index: -1; opacity: 0.6;
        }
        .blob-1 { top: -10%; left: -10%; width: 300px; height: 300px; background: #c7d2fe; }
        .blob-2 { bottom: 10%; right: -10%; width: 250px; height: 250px; background: #e0e7ff; }

        /* --- CLASES UTILITARIAS GLASS --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        /* --- VISTAS SPA (Sistema de Navegación) --- */
        .view-section {
            position: absolute;
            top: 0; left: 0; width: 100%; min-height: 100vh;
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s ease;
            display: none; /* Oculto por defecto */
            padding-bottom: 100px;
        }
        .view-section.active { display: block; transform: translateX(0); opacity: 1; z-index: 10; }
        /* Animación de entrada para producto */
        .view-section.slide-in { animation: slideInRight 0.3s forwards; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- HEADER --- */
        header { 
            position: sticky; top: 0; z-index: 50; 
            padding: 15px 20px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        
        /* --- CATALOGO --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; padding-top: 10px; }
        
        .category-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 10px 5px; margin-bottom: 10px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .cat-pill { 
            padding: 8px 18px; background: rgba(255,255,255,0.6); 
            border: 1px solid white; border-radius: 30px; 
            font-size: 0.85rem; font-weight: 600; color: var(--text-light); 
            white-space: nowrap; transition: 0.2s; backdrop-filter: blur(5px);
        }
        .cat-pill.active { background: var(--text-main); color: white; border-color: var(--text-main); transform: scale(1.05); }

        /* Tarjeta Catálogo */
        .card { 
            border-radius: var(--radius); overflow: hidden; 
            display: flex; flex-direction: column; transition: transform 0.2s;
        }
        .card:active { transform: scale(0.98); }
        .card-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #eee; }
        .card-body { padding: 12px; display: flex; flex-direction: column; gap: 4px; }
        .card-title { font-weight: 600; font-size: 0.95rem; line-height: 1.2; }
        .card-price { color: var(--accent); font-weight: 700; }

        /* --- DETALLE DE PRODUCTO (FULL PAGE) --- */
        #view-product { background: white; z-index: 100; padding-bottom: 0; }
        
        .product-nav {
            position: absolute; top: 0; left: 0; width: 100%; z-index: 20;
            padding: 15px 20px; display: flex; justify-content: space-between;
        }
        .nav-btn-circle {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: none; font-size: 1.1rem; color: #333; cursor: pointer;
        }

        /* Slider Hero */
        .hero-slider-container { position: relative; width: 100%; height: 45vh; background: #f1f5f9; overflow: hidden; }
        .slider-track { display: flex; height: 100%; width: 100%; transition: transform 0.3s ease-out; }
        .slider-img { width: 100%; height: 100%; object-fit: cover; flex-shrink: 0; }
        .slider-dots {
            position: absolute; bottom: 20px; left: 0; width: 100%; 
            display: flex; justify-content: center; gap: 8px; z-index: 10;
        }
        .dot { width: 8px; height: 8px; background: rgba(255,255,255,0.5); border-radius: 50%; transition: 0.2s; }
        .dot.active { background: white; transform: scale(1.2); }

        /* Cuerpo del producto (Glass Card que sube) */
        .product-details-container {
            position: relative; margin-top: -20px; 
            border-radius: 25px 25px 0 0;
            padding: 25px 20px 100px 20px; /* Padding bottom extra para el sticky bar */
            min-height: 60vh;
        }
        
        .prod-category { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-light); font-weight: 600; margin-bottom: 5px; }
        .prod-title { font-size: 1.6rem; font-weight: 800; line-height: 1.2; margin-bottom: 10px; color: var(--text-main); }
        
        .price-block { display: flex; align-items: baseline; gap: 10px; margin-bottom: 20px; }
        .real-price { font-size: 1.8rem; font-weight: 800; color: var(--accent); }
        .fake-price { text-decoration: line-through; color: #94a3b8; font-size: 1rem; }
        .discount-tag { background: #fee2e2; color: #dc2626; padding: 4px 10px; border-radius: 8px; font-size: 0.75rem; font-weight: bold; }

        .prod-desc { line-height: 1.6; color: #475569; font-size: 0.95rem; margin-bottom: 25px; }

        /* Social Proof Section */
        .social-section { 
            background: rgba(248, 250, 252, 0.5); border-radius: 16px; padding: 20px; margin-bottom: 20px; 
            border: 1px solid rgba(0,0,0,0.03);
        }
        .reaction-bar { display: flex; gap: 10px; margin-bottom: 15px; }
        .reaction-btn { 
            flex: 1; padding: 10px; border-radius: 12px; border: 1px solid #e2e8f0; 
            background: white; font-weight: 600; font-size: 0.9rem; 
            display: flex; align-items: center; justify-content: center; gap: 8px; 
            color: var(--text-light); transition: 0.2s;
        }
        .reaction-btn.active-love { background: #fee2e2; border-color: #fca5a5; color: #ef4444; }
        
        .comments-container { display: flex; flex-direction: column; gap: 15px; }
        .comment-card { display: flex; gap: 12px; font-size: 0.9rem; padding-bottom: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .comment-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        
        /* Sticky Action Bar */
        .sticky-action-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            padding: 15px 20px; z-index: 100;
            display: flex; gap: 15px; align-items: center;
            /* Glassmorphism intenso */
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255,255,255,0.5);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }
        .btn-add-main {
            flex: 1; padding: 16px; background: var(--text-main); color: white;
            border: none; border-radius: 14px; font-weight: 700; font-size: 1rem;
            display: flex; justify-content: center; align-items: center; gap: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15); transition: transform 0.1s;
        }
        .btn-add-main:active { transform: scale(0.96); }

        /* --- UI COMPONENTS FLOTANTES --- */
        .chat-btn { position: fixed; bottom: 90px; right: 20px; width: 55px; height: 55px; background: var(--accent); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4); z-index: 90; }
        .cart-float { position: fixed; bottom: 90px; left: 20px; background: white; padding: 12px 20px; border-radius: 30px; box-shadow: 0 10px 20px rgba(0,0,0,0.08); font-weight: bold; display: flex; gap: 10px; align-items: center; z-index: 90; border: 1px solid #f1f5f9; }
        
        /* Modales (Login, Cart, QR) */
        .overlay-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 2000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .overlay-modal.open { display: flex; opacity: 1; }
        
        /* Estilos específicos Cart y Login reutilizando glass */
        .cart-panel { background: white; width: 100%; max-height: 85vh; border-radius: 25px 25px 0 0; padding: 25px; position: fixed; bottom: 0; display: flex; flex-direction: column; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Login Card */
        .glass-card-center { background: white; width: 90%; max-width: 350px; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .input-glass { width: 100%; padding: 15px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; margin-bottom: 15px; font-size: 1rem; }

        /* Chat Widget */
        .chat-widget { display: none; position: fixed; bottom: 100px; right: 20px; width: 340px; max-width: 90%; height: 500px; background: white; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); flex-direction: column; z-index: 2100; overflow: hidden; }
        .chat-widget.open { display: flex; }
    </style>
</head>
<body>

    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>

    <div id="install-pwa-btn" style="display:none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 8px 20px; border-radius: 30px; z-index: 5000; font-size: 0.8rem; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
        <i class="fas fa-download"></i> Instalar App
    </div>

    <div id="view-catalog" class="view-section active">
        <header class="glass-panel" style="margin: 15px 20px; border-radius: 16px;">
            <div id="store-branding" style="font-weight: 800; font-size: 1.1rem; display:flex; align-items:center;">
                <i class="fas fa-store" style="color:var(--accent);"></i> <span style="margin-left:8px;">TIENDA</span>
            </div>
            <div style="display: flex; align-items: center; cursor:pointer;" onclick="openProfileSettings()">
                <div id="client-info" style="font-size: 0.8rem; color: #64748b; margin-right:8px; text-align:right;"></div>
                <img id="header-avatar" src="" style="width: 35px; height: 35px; border-radius: 50%; display:none; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            </div>
        </header>

        <div class="container">
            <h2 style="margin: 10px 0 15px 0; font-weight: 300; font-size:1.5rem;">Explorar</h2>
            <div id="category-filter" class="category-scroll"></div>
            <div id="products-grid" class="grid"></div>
            <div style="height: 100px;"></div> </div>

        <div class="chat-btn" onclick="toggleChat()">
            <i class="fas fa-comment-dots"></i>
            <span id="unread-badge" style="position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; font-size: 0.7rem; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; display:none; border:2px solid white;">0</span>
        </div>

        <div class="cart-float glass-panel" onclick="toggleCart()">
            <i class="fas fa-shopping-bag" style="color:var(--text-main);"></i> <span id="cart-total-badge">$0.00</span>
        </div>
    </div>

    <div id="view-product" class="view-section">
        <div class="product-nav">
            <button class="nav-btn-circle" onclick="navigateToCatalog()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <button class="nav-btn-circle" onclick="toggleCart()">
                <i class="fas fa-shopping-bag"></i>
            </button>
        </div>

        <div class="hero-slider-container">
            <div class="slider-track" id="slider-track"></div>
            <div class="slider-dots" id="slider-dots"></div>
        </div>

        <div class="product-details-container glass-panel">
            <div id="p-category" class="prod-category">CATEGORÍA</div>
            <h1 id="p-title" class="prod-title">Nombre del Producto</h1>
            
            <div class="price-block">
                <span id="p-price" class="real-price">$0.00</span>
                <span id="p-fake-price" class="fake-price">$0.00</span>
                <span class="discount-tag">¡OFERTA FLASH!</span>
            </div>

            <p id="p-desc" class="prod-desc">Descripción...</p>

            <div class="social-section">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                    <h3 style="font-size:1rem;">Opiniones</h3>
                    <div style="font-size:0.9rem; color:#fbbf24;"><i class="fas fa-star"></i> <span id="p-rating" style="color:var(--text-main); font-weight:bold;">4.9</span></div>
                </div>

                <div class="reaction-bar">
                    <div class="reaction-btn" id="btn-love" onclick="toggleReaction('love')">
                        <i class="fas fa-heart"></i> Me encanta (<span id="count-love">0</span>)
                    </div>
                    <div class="reaction-btn" onclick="toggleCommentBox()">
                        <i class="fas fa-pen"></i> Escribir
                    </div>
                </div>
                
                <div id="new-comment-area" style="display:none; margin-bottom:15px; background:white; padding:10px; border-radius:12px;">
                    <div style="display:flex; justify-content:center; gap:5px; margin-bottom:10px; color:#cbd5e1; font-size:1.5rem;">
                        <i class="fas fa-star star-sel" data-v="1" onclick="selStar(1)"></i>
                        <i class="fas fa-star star-sel" data-v="2" onclick="selStar(2)"></i>
                        <i class="fas fa-star star-sel" data-v="3" onclick="selStar(3)"></i>
                        <i class="fas fa-star star-sel" data-v="4" onclick="selStar(4)"></i>
                        <i class="fas fa-star star-sel" data-v="5" onclick="selStar(5)"></i>
                    </div>
                    <textarea id="comment-text" class="input-glass" rows="2" placeholder="Tu opinión..."></textarea>
                    <button onclick="postComment()" style="width:100%; background:var(--text-main); color:white; padding:10px; border-radius:8px; border:none; font-weight:bold;">Publicar</button>
                </div>

                <div id="comments-list" class="comments-container"></div>
            </div>
        </div>

        <div class="sticky-action-bar">
            <div style="display:flex; flex-direction:column;">
                <span style="font-size:0.7rem; color:#64748b;">Total</span>
                <span id="p-price-sticky" style="font-weight:800; font-size:1.1rem;">$0.00</span>
            </div>
            <button id="btn-add-cart" class="btn-add-main">
                <i class="fas fa-cart-plus"></i> AGREGAR AL CARRITO
            </button>
        </div>
    </div>

    <div id="login-overlay" class="overlay-modal">
        <div class="glass-card-center">
            <div id="step-store" style="display:none;">
                <h3>Código de Tienda</h3>
                <form onsubmit="handleStoreSubmit(event)">
                    <input type="text" id="reg-code" class="input-glass" placeholder="Ej: TIENDA-123" style="text-align:center; text-transform:uppercase; font-weight:bold;" required>
                    <button type="submit" class="btn-add-main" style="width:100%;">Ingresar</button>
                </form>
            </div>
            <div id="step-phone" style="display:none;">
                <h3>Identifícate</h3>
                <p style="font-size:0.85rem; color:#64748b; margin-bottom:15px;">Para gestionar tus pedidos</p>
                <form onsubmit="handlePhoneCheck(event)">
                    <input type="tel" id="check-phone" class="input-glass" placeholder="Tu WhatsApp" required>
                    <button type="submit" class="btn-add-main" style="width:100%;">Continuar</button>
                </form>
            </div>
            <div id="step-register" style="display:none;">
                <h3>Crear Perfil</h3>
                <div style="width:80px; height:80px; background:#f1f5f9; border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; cursor:pointer;" onclick="document.getElementById('avatar-in').click()">
                    <img id="avatar-prev" src="" style="width:100%; height:100%; border-radius:50%; object-fit:cover; display:none;">
                    <i id="avatar-icon" class="fas fa-camera" style="color:#94a3b8;"></i>
                </div>
                <input type="file" id="avatar-in" hidden accept="image/*" onchange="previewAvatar(this)">
                <input type="text" id="reg-name" class="input-glass" placeholder="Nombre y Apellido" required>
                <button onclick="registerUser()" class="btn-add-main" style="width:100%;">Crear</button>
            </div>
            <button onclick="closeLogin()" style="margin-top:15px; background:none; border:none; color:#64748b;">Cancelar</button>
        </div>
    </div>

    <div id="cart-overlay" class="overlay-modal" onclick="if(event.target===this) toggleCart()">
        <div class="cart-panel glass-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2>Tu Carrito</h2>
                <i class="fas fa-times" onclick="toggleCart()" style="font-size:1.2rem; padding:5px;"></i>
            </div>
            <div id="cart-items" style="flex:1; overflow-y:auto; margin-bottom:20px;"></div>
            
            <select id="del-method" class="input-glass" onchange="toggleAddr()">
                <option value="retiro">Retiro en Tienda</option>
                <option value="delivery">Delivery</option>
            </select>
            <div id="addr-box" style="display:none;">
                <textarea id="addr-text" class="input-glass" placeholder="Dirección..."></textarea>
            </div>
            
            <div id="bank-info" style="background:#f0f9ff; padding:15px; border-radius:12px; font-size:0.85rem; margin-bottom:15px; display:none; border:1px dashed #2563eb;"></div>

            <button onclick="checkout()" class="btn-add-main" style="width:100%;">Confirmar Pedido</button>
        </div>
    </div>

    <div class="chat-widget" id="chat-box">
        <div style="padding:15px; background:var(--accent); color:white; display:flex; justify-content:space-between;">
            <span>Soporte</span>
            <i class="fas fa-times" onclick="toggleChat()"></i>
        </div>
        <div id="chat-msgs" style="flex:1; padding:15px; overflow-y:auto; background:#f8fafc;"></div>
        <form onsubmit="sendMsg(event)" style="padding:10px; display:flex; border-top:1px solid #eee;">
            <input id="chat-in" type="text" placeholder="Escribe..." style="flex:1; border:none; outline:none;">
            <button type="submit" style="background:none; border:none; color:var(--accent); font-weight:bold;">Enviar</button>
        </form>
    </div>

    <script>
        const SUPABASE_URL = 'https://cirrapytmbnjlhxunkaq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpcnJhcHl0bWJuamxoeHVua2FxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NzAyMDAsImV4cCI6MjA3ODU0NjIwMH0.OtJiLGj1EvhPICFaA9ruL02Z9kSQ2jT0t3Smqph81C4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- STATE ---
        let session = { storeId: localStorage.getItem('sId'), clientId: localStorage.getItem('cId'), name: localStorage.getItem('cName'), avatar: localStorage.getItem('cAv') };
        let products = [], cart = [];
        let curProdId = null;
        let slideIdx = 0, slideImgs = [];
        let storeInfo = null;

        // --- INIT ---
        window.onload = async () => {
            // PWA Logic
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; if(!window.matchMedia('(display-mode: standalone)').matches) document.getElementById('install-pwa-btn').style.display='flex'; });
            document.getElementById('install-pwa-btn').onclick = async () => { if(deferredPrompt){ deferredPrompt.prompt(); const {outcome} = await deferredPrompt.userChoice; if(outcome==='accepted') document.getElementById('install-pwa-btn').style.display='none'; deferredPrompt=null; }};
            if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');

            // Routing fake
            const params = new URLSearchParams(location.search);
            const code = params.get('tienda') || params.get('u');
            
            if(code) await loadStore(code);
            else if(session.storeId) init();
            else openLogin('store');

            // Historial Back Button
            window.onpopstate = () => { navigateToCatalog(false); };
        };

        async function loadStore(code) {
            try {
                const {data} = await supabase.from('usuarios').select('*').or(`codigo_tienda.eq.${code.toUpperCase()},slug.eq.${code.toLowerCase()}`).single();
                if(!data) throw new Error();
                localStorage.setItem('sId', data.id); session.storeId = data.id; storeInfo = data;
                setManifest(data);
                init();
            } catch { alert('Tienda no existe'); openLogin('store'); }
        }

        function setManifest(data) {
            document.title = data.pwa_nombre_app || "Tienda";
            const icon = data.pwa_icono_b64 || data.logo_url || "https://cdn-icons-png.flaticon.com/512/1041/1041888.png";
            const blob = new Blob([JSON.stringify({
                name: data.pwa_nombre_app || "Tienda", short_name: "Tienda", start_url: location.href, display: "standalone",
                background_color: "#ffffff", theme_color: "#ffffff",
                icons: [{src: icon, sizes: "192x192", type: "image/png"}, {src: icon, sizes: "512x512", type: "image/png"}]
            })], {type: 'application/json'});
            document.getElementById('my-manifest-placeholder').setAttribute('href', URL.createObjectURL(blob));
        }

        async function init() {
            updateUserUI();
            const {data} = await supabase.from('productos').select('*').eq('creado_por', session.storeId).order('id', {ascending:false});
            products = data || [];
            renderCatalog();
            if(storeInfo) {
                if(storeInfo.logo_url) document.getElementById('store-branding').innerHTML = `<img src="${storeInfo.logo_url}" style="height:35px;">`;
                renderBankInfo();
            } else {
                // Fetch si no vino por URL
                const {data:s} = await supabase.from('usuarios').select('*').eq('id', session.storeId).single();
                storeInfo = s; renderBankInfo();
                if(s.logo_url) document.getElementById('store-branding').innerHTML = `<img src="${s.logo_url}" style="height:35px;">`;
            }
        }

        // --- CATALOGO ---
        function renderCatalog(filter = 'Todos') {
            const grid = document.getElementById('products-grid');
            const cats = ['Todos', ...new Set(products.map(p => p.categoria).filter(c=>c))];
            
            // Render Filters
            document.getElementById('category-filter').innerHTML = cats.map(c => 
                `<button class="cat-pill ${c===filter?'active':''}" onclick="renderCatalog('${c}')">${c}</button>`
            ).join('');

            const list = filter === 'Todos' ? products : products.filter(p => p.categoria === filter);
            grid.innerHTML = list.map(p => `
                <div class="card glass-panel" onclick="navigateToProduct(${p.id})">
                    <img src="${p.imagen_url}" class="card-img">
                    <div class="card-body">
                        <div class="card-title">${p.nombre}</div>
                        <div class="card-price">$${p.precio}</div>
                    </div>
                </div>
            `).join('');
        }

        // --- NAVEGACIÓN FULL PAGE (SPA Logic) ---
        async function navigateToProduct(id) {
            const p = products.find(x => x.id === id); if(!p) return;
            curProdId = id;

            // Update UI
            document.getElementById('p-category').textContent = p.categoria || 'GENERAL';
            document.getElementById('p-title').textContent = p.nombre;
            document.getElementById('p-price').textContent = `$${p.precio}`;
            document.getElementById('p-price-sticky').textContent = `$${p.precio}`;
            document.getElementById('p-fake-price').textContent = `$${(p.precio * 1.3).toFixed(2)}`;
            document.getElementById('p-desc').textContent = p.descripcion || 'Sin descripción';
            document.getElementById('btn-add-cart').onclick = () => { addToCart(p); };

            // Slider
            slideImgs = (p.galeria && p.galeria.length) ? p.galeria : [p.imagen_url];
            slideIdx = 0; updateSlider();

            // Reset Scroll
            window.scrollTo(0,0);
            
            // Switch Views
            document.getElementById('view-catalog').classList.remove('active');
            const pv = document.getElementById('view-product');
            pv.style.display = 'block';
            setTimeout(() => pv.classList.add('active'), 10); // Trigger transition
            
            // Push History
            history.pushState({view: 'product', id: id}, '', `#product-${id}`);
            
            // Load Social
            loadSocial(id);
        }

        function navigateToCatalog(back = true) {
            const pv = document.getElementById('view-product');
            pv.classList.remove('active');
            setTimeout(() => pv.style.display = 'none', 300);
            document.getElementById('view-catalog').classList.add('active');
            if(back && history.state && history.state.view === 'product') history.back();
        }

        // --- SLIDER ---
        function updateSlider() {
            const t = document.getElementById('slider-track');
            t.innerHTML = slideImgs.map(src => `<img src="${src}" class="slider-img">`).join('');
            t.style.transform = `translateX(-${slideIdx * 100}%)`;
            // Dots
            document.getElementById('slider-dots').innerHTML = slideImgs.map((_,i) => `<div class="dot ${i===slideIdx?'active':''}"></div>`).join('');
            
            // Auto swipe events could be added here
            t.onclick = () => { slideIdx = (slideIdx + 1) % slideImgs.length; updateSlider(); };
        }

        // --- SOCIAL PROOF ---
        async function loadSocial(pid) {
            const {data:reacts} = await supabase.from('reacciones').select('*').eq('producto_id', pid);
            const loves = reacts ? reacts.filter(r=>r.tipo==='love').length : 0;
            document.getElementById('count-love').textContent = loves;
            
            const btnLove = document.getElementById('btn-love');
            if(session.clientId && reacts && reacts.find(r=>r.cliente_id == session.clientId && r.tipo==='love')) btnLove.classList.add('active-love');
            else btnLove.classList.remove('active-love');

            const {data:coms} = await supabase.from('comentarios').select('*, clientes(nombre, foto_b64)').eq('producto_id', pid).order('created_at', {ascending:false});
            const list = document.getElementById('comments-list');
            if(!coms || !coms.length) { list.innerHTML = '<div style="color:#94a3b8; font-style:italic;">Sé el primero en opinar.</div>'; document.getElementById('p-rating').textContent='5.0'; return; }
            
            const avg = (coms.reduce((a,b)=>a+b.estrellas,0)/coms.length).toFixed(1);
            document.getElementById('p-rating').textContent = avg;
            
            list.innerHTML = coms.map(c => `
                <div class="comment-card">
                    <img src="${c.clientes?.foto_b64 || 'https://ui-avatars.com/api/?background=random&name='+c.clientes?.nombre}" class="comment-avatar">
                    <div style="flex:1;">
                        <div style="font-weight:bold; display:flex; justify-content:space-between;">
                            ${c.clientes?.nombre}
                            <span style="color:#fbbf24; font-size:0.8rem;">${'★'.repeat(c.estrellas)}</span>
                        </div>
                        <div style="color:#475569;">${c.texto}</div>
                    </div>
                </div>
            `).join('');
        }

        let selStars = 5;
        function selStar(n) { selStars=n; document.querySelectorAll('.star-sel').forEach(s => s.style.color = s.dataset.v <= n ? '#fbbf24' : '#cbd5e1'); }
        function toggleCommentBox() { 
            if(!session.clientId) return openLogin('phone');
            const box = document.getElementById('new-comment-area'); box.style.display = box.style.display==='none'?'block':'none'; 
        }
        async function postComment() {
            const txt = document.getElementById('comment-text').value;
            if(!txt) return;
            await supabase.from('comentarios').insert({ producto_id: curProdId, cliente_id: session.clientId, texto: txt, estrellas: selStars });
            document.getElementById('comment-text').value=''; toggleCommentBox(); loadSocial(curProdId);
        }
        async function toggleReaction(type) {
            if(!session.clientId) return openLogin('phone');
            const {data:ex} = await supabase.from('reacciones').select('id').eq('producto_id', curProdId).eq('cliente_id', session.clientId).single();
            if(ex) await supabase.from('reacciones').delete().eq('id', ex.id);
            else await supabase.from('reacciones').insert({producto_id: curProdId, cliente_id: session.clientId, tipo: type});
            loadSocial(curProdId);
        }

        // --- CART ---
        function addToCart(p) {
            cart.push(p); updateCartCount();
            // Feedback visual
            const b = document.getElementById('btn-add-cart');
            const old = b.innerHTML; b.innerHTML = '<i class="fas fa-check"></i> AGREGADO'; b.style.background="#22c55e";
            setTimeout(()=>{ b.innerHTML = old; b.style.background="var(--text-main)"; }, 1500);
        }
        function updateCartCount() {
            const t = cart.reduce((a,b)=>a+b.precio,0);
            document.getElementById('cart-total-badge').textContent = `$${t.toFixed(2)}`;
            const list = document.getElementById('cart-items');
            list.innerHTML = cart.map((p,i) => `
                <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;">
                    <div>${p.nombre} <div style="font-weight:bold;">$${p.precio}</div></div>
                    <i class="fas fa-trash" style="color:#ef4444; cursor:pointer;" onclick="cart.splice(${i},1); updateCartCount()"></i>
                </div>
            `).join('') || '<p style="text-align:center; color:#ccc;">Vacío</p>';
        }
        function toggleCart() { 
            const m = document.getElementById('cart-overlay'); 
            if(m.classList.contains('open')) m.classList.remove('open');
            else m.classList.add('open'); 
        }
        function toggleAddr() { document.getElementById('addr-box').style.display = document.getElementById('del-method').value==='delivery'?'block':'none'; }
        
        function renderBankInfo() {
            if(storeInfo && storeInfo.banco_numero) {
                const b = document.getElementById('bank-info');
                b.style.display = 'block';
                b.innerHTML = `<b>Datos de Pago:</b><br>${storeInfo.banco_nombre} - ${storeInfo.banco_titular}<br>${storeInfo.banco_numero}`;
            }
        }

        async function checkout() {
            if(!cart.length) return alert('Carrito vacío');
            if(!session.clientId) return openLogin('phone');
            const total = cart.reduce((a,b)=>a+b.precio,0);
            const method = document.getElementById('del-method').value;
            const addr = document.getElementById('addr-text').value;
            if(method==='delivery' && !addr) return alert('Dirección requerida');

            await supabase.from('pedidos').insert({
                tienda_id: session.storeId, cliente_id: session.clientId,
                total: total, estado: 'pendiente', productos: cart
            });
            const msg = `Nuevo Pedido ($${total}) - ${method.toUpperCase()} ${addr ? ': '+addr : ''}`;
            await supabase.from('mensajes').insert({tienda_id: session.storeId, cliente_id: session.clientId, enviado_por_rol: 'cliente', contenido: msg});
            
            cart = []; updateCartCount(); toggleCart(); alert('¡Pedido Enviado!');
        }

        // --- LOGIN SYSTEM ---
        function openLogin(step) {
            document.getElementById('login-overlay').classList.add('open');
            document.getElementById('step-store').style.display='none';
            document.getElementById('step-phone').style.display='none';
            document.getElementById('step-register').style.display='none';
            document.getElementById('step-'+step).style.display='block';
        }
        function closeLogin() { document.getElementById('login-overlay').classList.remove('open'); }
        function openProfileSettings() { if(session.clientId) alert('Sesión: '+session.name); else openLogin('phone'); }

        async function handleStoreSubmit(e) { e.preventDefault(); await loadStore(document.getElementById('reg-code').value); closeLogin(); }
        async function handlePhoneCheck(e) {
            e.preventDefault(); const ph = document.getElementById('check-phone').value;
            const {data} = await supabase.from('clientes').select('*').eq('telefono', ph).single();
            if(data) { saveSession(data); closeLogin(); }
            else { document.getElementById('step-phone').style.display='none'; document.getElementById('step-register').style.display='block'; }
        }
        function previewAvatar(inpt) {
            const f = inpt.files[0]; const r = new FileReader();
            r.onload = (e) => { 
                document.getElementById('avatar-prev').src = e.target.result; 
                document.getElementById('avatar-prev').style.display='block';
                document.getElementById('avatar-icon').style.display='none';
            };
            r.readAsDataURL(f);
        }
        async function registerUser() {
            const ph = document.getElementById('check-phone').value;
            const nm = document.getElementById('reg-name').value;
            const img = document.getElementById('avatar-prev').src;
            const {data} = await supabase.from('clientes').insert({nombre:nm, telefono:ph, foto_b64: img.length<100000?img:null}).select().single();
            saveSession(data); closeLogin();
        }
        function saveSession(u) {
            localStorage.setItem('cId', u.id); localStorage.setItem('cName', u.nombre); localStorage.setItem('cAv', u.foto_b64);
            session.clientId = u.id; session.name = u.nombre; session.avatar = u.foto_b64;
            updateUserUI();
        }
        function updateUserUI() {
            if(session.name) {
                document.getElementById('client-info').textContent = session.name.split(' ')[0];
                const img = document.getElementById('header-avatar');
                img.src = session.avatar || `https://ui-avatars.com/api/?name=${session.name}`;
                img.style.display = 'block';
            }
        }

        // --- CHAT ---
        function toggleChat() { 
            if(!session.clientId) return openLogin('phone');
            const c = document.getElementById('chat-box');
            if(c.classList.contains('open')) c.classList.remove('open'); else { c.classList.add('open'); loadChat(); }
        }
        async function loadChat() {
            const {data} = await supabase.from('mensajes').select('*').eq('tienda_id', session.storeId).eq('cliente_id', session.clientId).order('created_at');
            const div = document.getElementById('chat-msgs');
            div.innerHTML = data.map(m => `<div style="background:${m.enviado_por_rol==='cliente'?'#e0e7ff':'#f1f5f9'}; padding:8px; border-radius:8px; margin-bottom:5px; align-self:${m.enviado_por_rol==='cliente'?'flex-end':'flex-start'}; max-width:80%; margin-left:${m.enviado_por_rol==='cliente'?'auto':'0'};">${m.contenido}</div>`).join('');
            div.scrollTop = div.scrollHeight;
        }
        async function sendMsg(e) {
            e.preventDefault(); const txt = document.getElementById('chat-in').value; if(!txt) return;
            await supabase.from('mensajes').insert({tienda_id: session.storeId, cliente_id: session.clientId, enviado_por_rol: 'cliente', contenido: txt});
            document.getElementById('chat-in').value=''; loadChat();
        }

    </script>
</body>
</html>
