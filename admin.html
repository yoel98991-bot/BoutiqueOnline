<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <title>Admin Panel</title>

    <link rel="manifest" href="./manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Studio">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- ESTILOS GENERALES --- */
        :root { --primary: #1e293b; --accent: #6366f1; --bg: #f8fafc; --surface: #ffffff; --text: #334155; --border: #e2e8f0; --radius: 16px; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 15px; min-height: 100vh; padding-bottom: 80px; }
        .container { max-width: 960px; margin: 0 auto; }

        /* Login */
        #login-container { max-width: 100%; width: 400px; margin: 60px auto; background: var(--surface); padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--surface); padding: 15px 20px; border-radius: var(--radius); box-shadow: var(--shadow); flex-wrap: wrap; gap: 10px;}
        .store-code-badge { background: #eff6ff; color: var(--accent); padding: 5px 12px; border-radius: 8px; font-weight: 600; border: 1px dashed var(--accent); font-size: 0.9rem; cursor: pointer; transition: border-color 0.3s; border-width: 2px; }

        /* Tabs Navigation */
        .nav-tabs { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            overflow-x: auto; 
            padding: 10px; 
            margin-left: -10px; 
            margin-right: -10px;
            width: calc(100% + 20px);
        }
        .nav-tabs::-webkit-scrollbar { display: none; }
        .tab { padding: 10px 20px; border: none; background: white; color: #64748b; font-weight: 600; border-radius: 30px; font-size: 0.9rem; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.02); position: relative; }
        .tab.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(30, 41, 59, 0.3); }

        /* Badges */
        .badge-count { 
            position: absolute; 
            top: -8px; 
            right: -5px; 
            background-color: #ef4444; 
            color: white; 
            font-size: 0.7rem; 
            padding: 2px 6px; 
            border-radius: 10px; 
            font-weight: bold; 
            display: none; 
            animation: popIn 0.3s ease;
            z-index: 10; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
            border: 2px solid white; 
        }

        /* Toasts */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast-notification { background: white; border-left: 4px solid var(--accent); padding: 15px 20px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 15px; animation: slideInRight 0.3s ease-out forwards; min-width: 250px; }
        .toast-content div { font-weight: 600; font-size: 0.9rem; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* UI Components */
        .card { background: var(--surface); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { display: block; margin-bottom: 6px; font-size: 0.8rem; font-weight: 600; color: #64748b; text-transform: uppercase; }
        input, textarea, select { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 12px; background: #f8fafc; font-family: 'Inter', sans-serif; font-size: 16px; appearance: none; }
        .btn { padding: 14px 20px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; width: 100%; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); padding: 8px 16px; font-size: 0.9rem; width: auto; }
        .btn-icon { width: 36px; height: 36px; padding: 0; border-radius: 8px; display: inline-flex; margin-left: 5px; align-items: center; justify-content: center;}
        .btn-danger { background: #fee2e2; color: #dc2626; }
        .btn-edit { background: #e0e7ff; color: var(--accent); }
        .upload-zone { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 30px 20px; text-align: center; background: #f8fafc; margin-bottom: 20px; cursor: pointer; }
        .panel-section { display: none; animation: fadeIn 0.3s ease; }
        .panel-section.active { display: block; }

        /* GALER칈A DE PREVISUALIZACI칍N */
        .gallery-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        .gallery-item {
            position: relative;
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .btn-remove-img {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        /* Table */
        .table-container { overflow-x: auto; margin: 0 -20px; padding: 0 20px; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        .product-img { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; background: #eee; }

        /* Orders */
        .order-item { padding: 15px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 12px; background: white; transition: all 0.3s ease; }
        .badge-pending { background: #fff7ed; color: #c2410c; font-size: 0.7rem; padding: 4px 8px; border-radius: 10px; font-weight: bold;}
        
        /* --- CHAT EN PANTALLA COMPLETA (WhatsApp Style) --- */
        .chat-window { 
            display: none; 
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #0c1317;
            z-index: 9999;
            flex-direction: column;
            border-radius: 0;
            box-shadow: none;
            opacity: 0;
            transition: opacity 0.3s ease-out;
            will-change: opacity; /* <--- AGREGA ESTO SI PUEDES */
            
        }

        .chat-window.active { 
            display: flex;
            opacity: 1;
            animation: chatSlideIn 0.3s ease-out forwards;
        }

        @keyframes chatSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Header fijo estilo WhatsApp */
        .chat-header {
            background: #202c33;
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            height: 70px;
        }

        .chat-header .btn-outline {
            color: white;
            border-color: rgba(255,255,255,0.2);
            padding: 8px 16px;
            font-size: 0.9rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.1);
        }

        .chat-header-info {
            flex: 1;
        }

        .chat-header-info div:first-child {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 3px;
        }

        .chat-header-info div:last-child {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.6);
        }

        /* 츼rea de mensajes - fondo WhatsApp */
        .chat-messages {
            flex: 1;
            padding: 20px 15px;
            overflow-y: auto;
            background: #0c1317;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxkZWZzPjxwYXR0ZXJuIGlkPSJwYXR0ZXJuIiB4PSIwIiB5PSIwIiB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHBhdHRlcm5Vbml0cz0idXNlclNwYWNlT25Vc2UiIHBhdHRlcm5UcmFuc2Zvcm09InJvdGF0ZSg0NSkiPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgZmlsbD0icmdiYSgyMzUsMjM5LDIzOSwwLjAyKSIvPjxyZWN0IHg9IjIwIiB5PSIyMCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiBmaWxsPSJyZ2JhKDIzNSwyMzksMjM5LDAuMDIpIi8+PC9wYXR0ZXJuPjwvZGVmcz48cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI3BhdHRlcm4pIiBvcGFjaXR5PSIwLjA1Ii8+PC9zdmc+');
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-bottom: 100px;
        }

        /* Filas de mensajes mejoradas */
        .msg-row {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }

        .msg-row.me {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .msg-row.them {
            align-self: flex-start;
        }

        .msg-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        /* Burbujas de mensaje estilo WhatsApp */
        .msg-bubble {
            padding: 8px 12px;
            border-radius: 18px;
            font-size: 0.95rem;
            position: relative;
            line-height: 1.4;
            word-wrap: break-word;
            max-width: 100%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .msg-row.me .msg-bubble {
            background: #005c4b;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .msg-row.them .msg-bubble {
            background: #202c33;
            color: #e9edef;
            border-bottom-left-radius: 4px;
        }

        /* Indicador de tiempo en mensajes */
        .msg-time {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.6);
            margin-top: 3px;
            text-align: right;
            display: block;
        }

        .msg-row.them .msg-time {
            color: rgba(255,255,255,0.5);
            text-align: left;
        }

        /* Control estricto de im치genes en chat */
        .msg-bubble img {
            max-width: 100%;
            max-height: 250px;
            border-radius: 8px;
            margin-top: 5px;
            display: block;
            object-fit: cover;
        }

        .msg-bubble:has(img) {
            max-width: 280px;
            background: transparent !important;
            padding: 0;
        }

        /* 츼rea de entrada fija en la parte inferior */
        .chat-input-area {
            padding: 15px 20px;
            background: #202c33;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-shrink: 0;
            border-top: 1px solid rgba(255,255,255,0.05);
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            box-sizing: border-box;
        }

        .chat-input-area input {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            background: #2a3942;
            color: white;
            font-size: 1rem;
            outline: none;
        }

        .chat-input-area input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .chat-input-area button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #005c4b;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: background 0.2s;
        }

        .chat-input-area button:hover {
            background: #006e5a;
        }

        /* Indicador de escritura */
        .typing-indicator {
            padding: 0 20px;
            color: rgba(255,255,255,0.6);
            font-size: 0.85rem;
            font-style: italic;
            height: 20px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .typing-indicator::before {
            content: "";
            width: 8px;
            height: 8px;
            background: #005c4b;
            border-radius: 50%;
            animation: typingPulse 1.5s infinite;
        }

        @keyframes typingPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* Scrollbar personalizada para el chat */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Efectos de entrada/salida */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* CROPPER */
        #crop-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index: 5000; display:none; justify-content:center; align-items:center; flex-direction:column; padding: 20px; }
        .crop-container { max-width: 90%; max-height: 70vh; background: #333; overflow: hidden; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .crop-container img { max-width: 100%; display: block; }
        .crop-controls { margin-top: 20px; display: flex; gap: 15px; }
        
        .logo-preview-container { background: white; border: 2px dashed #cbd5e1; border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; margin-bottom: 20px; transition: 0.3s; }
        .logo-preview-container:hover { border-color: var(--accent); background: #f0f9ff; }
        .current-logo { max-height: 60px; max-width: 100%; object-fit: contain; }

        /* ESTILOS PARA RESUMEN */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); position: relative; overflow: hidden; }
        .stat-card h4 { margin: 0 0 10px 0; color: #64748b; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-card .value { font-size: 2rem; font-weight: 700; color: var(--primary); }
        .stat-card .sub-text { font-size: 0.85rem; color: var(--accent); margin-top: 5px; font-weight: 500; }
        .stat-card .icon-bg { position: absolute; bottom: -10px; right: -10px; font-size: 5rem; color: rgba(0,0,0,0.03); transform: rotate(-15deg); }
        .top-client-box { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; }
        .top-client-box h4 { color: rgba(255,255,255,0.8); }
        .top-client-box .value { color: white; font-size: 1.5rem; }
        .top-client-box .sub-text { color: rgba(255,255,255,0.9); }

        /* MODAL PERSONALIZADO */
        .custom-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px);
            z-index: 9999; display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .custom-modal-overlay.open { display: flex; opacity: 1; }
        
        .custom-modal-card {
            background: white; width: 90%; max-width: 400px; padding: 25px;
            border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            text-align: center; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative; overflow: hidden;
        }
        .custom-modal-overlay.open .custom-modal-card { transform: scale(1); }

        .modal-icon-wrapper {
            width: 70px; height: 70px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 15px auto; font-size: 2rem;
        }
        
        /* Tipos de Modal */
        .modal-type-success .modal-icon-wrapper { background: #dcfce7; color: #16a34a; }
        .modal-type-danger .modal-icon-wrapper { background: #fee2e2; color: #dc2626; }
        .modal-type-info .modal-icon-wrapper { background: #e0e7ff; color: #4f46e5; }
        
        .modal-title { font-size: 1.25rem; font-weight: 700; color: #1e293b; margin-bottom: 10px; }
        .modal-desc { color: #64748b; font-size: 0.95rem; line-height: 1.5; margin-bottom: 25px; }
        
        .modal-actions { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 12px; font-weight: 600; border: none; cursor: pointer; font-size: 1rem; transition: transform 0.1s; }
        .modal-btn:active { transform: scale(0.96); }
        .modal-btn-cancel { background: #f1f5f9; color: #64748b; }
        
        .modal-type-success .modal-btn-confirm { background: #16a34a; color: white; box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3); }
        .modal-type-danger .modal-btn-confirm { background: #dc2626; color: white; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3); }
        .modal-type-info .modal-btn-confirm { background: #4f46e5; color: white; }

        /* ONBOARDING STYLES (NUEVO) */
        .onboarding-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 25px;
            border-radius: var(--radius);
            margin-bottom: 25px;
            box-shadow: 0 10px 25px rgba(30, 41, 59, 0.3);
            position: relative;
            overflow: hidden;
            display: none; /* Se muestra con JS si es necesario */
        }
        .onboarding-card::before {
            content: ''; position: absolute; top: -50px; right: -50px;
            width: 150px; height: 150px; background: rgba(255,255,255,0.05);
            border-radius: 50%;
        }
        .onboarding-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .onboarding-title { font-size: 1.2rem; font-weight: 700; margin: 0; }
        .onboarding-subtitle { opacity: 0.8; font-size: 0.9rem; margin-top: 5px; }
        
        .progress-container { margin: 15px 0; }
        .progress-bar-bg { height: 8px; background: rgba(255,255,255,0.2); border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: #22c55e; width: 0%; transition: width 0.5s ease; box-shadow: 0 0 10px rgba(34, 197, 94, 0.5); }
        .progress-text { font-size: 0.8rem; font-weight: 600; text-align: right; margin-top: 5px; color: #4ade80; }

        .steps-list { display: flex; flex-direction: column; gap: 10px; }
        .step-item { 
            background: rgba(255,255,255,0.1); padding: 12px 15px; border-radius: 12px; 
            display: flex; align-items: center; justify-content: space-between;
            transition: 0.2s; border: 1px solid rgba(255,255,255,0.05);
        }
        .step-item:hover { background: rgba(255,255,255,0.15); }
        .step-info { display: flex; align-items: center; gap: 12px; }
        .step-icon { 
            width: 32px; height: 32px; background: rgba(255,255,255,0.2); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 0.9rem;
        }
        .step-item.done .step-icon { background: #22c55e; color: white; }
        .step-item.done .step-text { text-decoration: line-through; opacity: 0.6; }
        .step-action { 
            padding: 6px 12px; font-size: 0.8rem; background: white; color: #1e293b; 
            border-radius: 20px; font-weight: 600; border: none; cursor: pointer;
        }
        .step-action:hover { transform: scale(1.05); }
        .close-onboarding {
            background: none; border: none; color: rgba(255,255,255,0.5); 
            cursor: pointer; font-size: 1.1rem;
        }
        .close-onboarding:hover { color: white; }

        /* Responsive */
        @media (max-width: 768px) {
            .contact-stats {
                flex-direction: column;
                align-items: flex-end;
                gap: 5px;
            }
            
            .contact-card {
                padding: 12px;
            }
        }

        /* ESTILOS SIMPLIFICADOS PARA CONTACTOS */
        .simple-contact-card {
            transition: all 0.3s ease !important;
        }

        .simple-contact-card:hover {
            border-color: #6366f1 !important;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1) !important;
        }

        .unread-contact {
            border-left: 4px solid #6366f1 !important;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%) !important;
        }

        /* Asegurar que el contenedor sea vertical */
        #contacts-grid {
            height: 100%;
            overflow-y: auto;
            width: 100%;
        }

        #contacts-grid::-webkit-scrollbar {
            width: 6px;
        }

        #contacts-grid::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        #contacts-grid::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        #contacts-grid::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Para pantallas grandes (modo escritorio) */
        @media (min-width: 768px) {
            .chat-window {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 90%;
                max-width: 500px;
                height: 90vh;
                max-height: 800px;
                border-radius: 20px;
                overflow: hidden;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            }
            
            .chat-header {
                border-radius: 20px 20px 0 0;
            }
        }
    </style>
</head>
<body>

    <div id="login-container">
        <h2 id="auth-title" style="margin-bottom: 10px;">Admin Access</h2>
        <form id="auth-form">
            <input type="email" id="email" placeholder="Correo Electr칩nico" required>
            <input type="password" id="password" placeholder="Contrase침a" required>
            <button type="submit" id="btn-auth-action" class="btn btn-primary">Ingresar</button>
        </form>
        <p id="auth-msg" style="color: var(--accent); margin-top: 15px; min-height: 20px; font-size: 0.9rem;"></p>

        <div style="margin-top: 20px; border-top: 1px solid #e2e8f0; padding-top: 15px; font-size: 0.9rem; color: #64748b;">
            <span id="toggle-text">쯅o tienes cuenta?</span>
            <button type="button" id="btn-toggle-auth" onclick="toggleAuthMode()" 
                    style="background:none; border:none; color: var(--accent); font-weight:bold; cursor:pointer; font-size: 0.9rem; text-decoration: underline;">
                Crear Tienda
            </button>
        </div>
    </div>

    <div id="toast-container"></div>

    <div id="app-modal" class="custom-modal-overlay">
        <div class="custom-modal-card" id="modal-card-content">
            <div id="modal-icon" class="modal-icon-wrapper"><i class="fas fa-check"></i></div>
            <h3 id="modal-title" class="modal-title">T칤tulo</h3>
            <p id="modal-msg" class="modal-desc">Descripci칩n aqu칤.</p>
            <div class="modal-actions" id="modal-actions">
                <button class="modal-btn modal-btn-cancel" onclick="closeCustomModal()">Cancelar</button>
                <button id="btn-modal-confirm" class="modal-btn modal-btn-confirm">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="dashboard" class="container" style="display:none;">
        <div class="header">
            <div>
                <h2 style="margin:0; font-size:1.1rem; color: var(--primary);">Studio Panel</h2>
                
                <div style="display:flex; gap: 10px; margin-top: 5px; align-items: center;">
                    <div id="store-code-display" class="store-code-badge" onclick="copyCode()" title="Copiar c칩digo">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>

                    <button onclick="shareStoreLink()" class="btn-icon" style="background: var(--accent); color: white; box-shadow: 0 2px 5px rgba(99, 102, 241, 0.4); width: auto; padding: 0 12px; font-size: 0.85rem; height: 32px;" title="Promocionar Tienda">
                        <i class="fas fa-share-alt"></i> <span style="margin-left:5px;">Promocionar</span>
                    </button>
                </div>
            </div>
            <button onclick="logout()" class="btn btn-outline"><i class="fas fa-sign-out-alt"></i></button>
        </div>

        <div id="onboarding-card" class="onboarding-card">
            <div class="onboarding-header">
                <div>
                    <h3 class="onboarding-title">춰Bienvenido a tu Tienda! 游</h3>
                    <div class="onboarding-subtitle">Completa estos 3 pasos para empezar a vender.</div>
                </div>
                <button class="close-onboarding" onclick="hideOnboarding()" title="Ocultar"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar-bg">
                    <div id="ob-progress-fill" class="progress-fill"></div>
                </div>
                <div id="ob-progress-text" class="progress-text">0% Completado</div>
            </div>

            <div class="steps-list">
                <div id="step-1" class="step-item">
                    <div class="step-info">
                        <div class="step-icon"><i class="fas fa-box"></i></div>
                        <span class="step-text">Crea tu primer producto</span>
                    </div>
                    <button class="step-action" onclick="goToAddProduct()">Crear</button>
                </div>
                <div id="step-2" class="step-item">
                    <div class="step-info">
                        <div class="step-icon"><i class="fas fa-share-alt"></i></div>
                        <span class="step-text">Comparte tu enlace</span>
                    </div>
                    <button class="step-action" onclick="completeShareStep()">Compartir</button>
                </div>
                <div id="step-3" class="step-item">
                    <div class="step-info">
                        <div class="step-icon"><i class="fas fa-star"></i></div>
                        <span class="step-text">Recibe tu primer pedido</span>
                    </div>
                    <span style="font-size:0.75rem; opacity:0.8;">Esperando ventas...</span>
                </div>
            </div>
        </div>
        <div class="nav-tabs">
            <button class="tab" onclick="switchTab('resumen')"><i class="fas fa-chart-pie"></i> Resumen</button>
            <button class="tab active" onclick="switchTab('productos')"><i class="fas fa-box"></i> Productos</button>
            <button class="tab" onclick="switchTab('chats')"><i class="fas fa-comments"></i> Chats <span id="badge-chats" class="badge-count">0</span></button>
            <button class="tab" onclick="switchTab('pedidos')"><i class="fas fa-bell"></i> Pedidos <span id="badge-orders" class="badge-count">0</span></button>
            <button class="tab" onclick="switchTab('config')"><i class="fas fa-cog"></i> Configuraci칩n</button>
        </div>

        <div id="tab-resumen" class="panel-section">
            <h3 style="margin-bottom:20px;">Estad칤sticas de la Tienda</h3>
            
            <div class="summary-grid">
                <div class="stat-card">
                    <h4>Ingresos Totales</h4>
                    <div class="value" id="stat-income">$0.00</div>
                    <div class="sub-text">En pedidos despachados</div>
                    <i class="fas fa-wallet icon-bg"></i>
                </div>
        
                <div class="stat-card">
                    <h4>Pedidos Completados</h4>
                    <div class="value" id="stat-orders">0</div>
                    <div class="sub-text">Env칤os realizados</div>
                    <i class="fas fa-shipping-fast icon-bg"></i>
                </div>
        
                <div class="stat-card top-client-box">
                    <h4>游끥 Cliente Top</h4>
                    <div class="value" id="stat-top-client">---</div>
                    <div class="sub-text" id="stat-top-spent">Sin datos a칰n</div>
                    <i class="fas fa-crown icon-bg" style="color: rgba(255,255,255,0.1);"></i>
                </div>
            </div>
        
            <div class="card">
                <h3>칔ltimos Movimientos</h3>
                <div class="table-container">
                    <table id="recent-sales-table">
                        <thead><tr><th>Cliente</th><th>Monto</th><th>Fecha</th></tr></thead>
                        <tbody id="recent-sales-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-productos" class="panel-section active">
            <div class="card" id="form-card">
                <h3 id="form-title"><i class="fas fa-plus-circle"></i> Nuevo Producto</h3>
                <form id="product-form">
                    <div class="form-grid">
                        <input type="text" id="nombre" placeholder="Nombre" required>
                        <input type="number" step="0.01" id="precio" placeholder="Precio" required>
                    </div>
                    <textarea id="descripcion" rows="2" placeholder="Descripci칩n"></textarea>
                    
                    <div class="form-grid">
                        <input type="text" id="marca" placeholder="Marca (Ej: Nike, Apple)" style="background: white;">
                        <input type="number" id="stock" value="10" placeholder="Stock">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <input type="text" id="categoria" list="lista-categorias" placeholder="Categor칤a (Escribe o selecciona)" style="width:100%;">
                        <datalist id="lista-categorias"></datalist>
                    </div>
                    
                    <label style="margin-top:10px; display:block;">Galer칤a de Im치genes (M치x 6)</label>
                    <div class="upload-zone" onclick="document.getElementById('imagen-input').click()">
                        <p id="upload-text" style="margin:0; color:#64748b;">
                            <i class="fas fa-images"></i> Toca para seleccionar fotos
                        </p>
                        <input type="file" id="imagen-input" accept="image/*" multiple style="display:none;">
                    </div>
                    
                    <div id="gallery-preview-container" class="gallery-preview-grid"></div>

                    <div style="margin-bottom: 15px;"><input type="checkbox" id="destacado"> Destacar</div>
                    <button type="submit" id="btn-save" class="btn btn-primary">Publicar</button>
                    <button type="button" id="btn-cancel" class="btn btn-cancel" style="display:none;" onclick="resetForm()">Cancelar</button>
                </form>
            </div>
            <div class="card">
                <h3><i class="fas fa-layer-group"></i> Inventario</h3>
                <div class="table-container"><table id="products-table"></table></div>
            </div>
        </div>

        <div id="tab-chats" class="panel-section">
            <!-- NUEVA BANDEJA DE ENTRADA - ESTRUCTURA SIMPLIFICADA -->
            <div id="chats-inbox" class="card" style="padding: 0; height: 75vh; display: flex; flex-direction: column;">
                <div class="chats-header" style="padding: 20px; border-bottom: 1px solid #e2e8f0;">
                    <h3 style="margin: 0; font-size: 1.2rem; color: #1e293b;">
                        <i class="fas fa-inbox"></i> Bandeja de Entrada
                    </h3>
                    <div style="margin-top: 15px;">
                        <input type="text" 
                               class="chats-search-input" 
                               id="chats-search" 
                               placeholder="Buscar contacto por nombre..." 
                               onkeyup="filterContacts()"
                               style="
                                   padding: 12px 15px;
                                   border: 1px solid #e2e8f0;
                                   border-radius: 12px;
                                   background: #f8fafc;
                                   width: 100%;
                                   font-size: 0.9rem;
                                   color: #334155;
                               ">
                    </div>
                </div>
                
                <!-- CONTENEDOR PRINCIPAL CON SCROLL VERTICAL -->
                <div id="contacts-grid" style="
                    flex: 1;
                    overflow-y: auto;
                    padding: 15px;
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                    width: 100%;
                    box-sizing: border-box;
                ">
                    <!-- Los contactos se cargar치n aqu칤 din치micamente -->
                    <div class="no-contacts" style="text-align: center; padding: 60px 20px; color: #94a3b8;">
                        <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h4 style="margin: 10px 0;">No hay conversaciones activas</h4>
                        <p style="margin: 0; font-size: 0.9rem;">Cuando los clientes te escriban, aparecer치n aqu칤 organizados por contacto.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-pedidos" class="panel-section">
            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <h3>Pedidos</h3>
                    <button onclick="loadOrders()" class="btn btn-outline"><i class="fas fa-sync"></i></button>
                </div>
                <div id="orders-list"></div>
            </div>
        </div>

       <div id="tab-config" class="panel-section">
            <div class="card">
                <h3><i class="fas fa-mobile-alt"></i> Personalizaci칩n de la App (PWA)</h3>
                <p style="font-size:0.85rem; color:#64748b; margin-bottom:15px;">
                    Configura c칩mo se ver치 tu tienda cuando los clientes la instalen en su celular.
                </p>
                
                <div class="form-grid">
                    <div>
                        <label>Nombre de la App</label>
                        <input type="text" id="conf-pwa-nombre" placeholder="Ej: Mi Boutique (M치x 12 letras)" maxlength="15">
                    </div>
                </div>

                <label>칈cono de la App (Cuadrado)</label>
                <div class="upload-zone" onclick="document.getElementById('pwa-icon-input').click()">
                    <p id="pwa-text" style="margin:0; color:#64748b;">Toca para subir 칤cono (Se guardar치 como texto)</p>
                    <img id="pwa-preview" style="display:none; width:80px; height:80px; margin:10px auto; border-radius:15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
                    <input type="file" id="pwa-icon-input" accept="image/*" style="display:none;" onchange="processPwaIcon(this)">
                </div>
                <input type="hidden" id="conf-pwa-b64">
            </div>

            <div class="card">
                <h3><i class="fas fa-image"></i> Logo de la Tienda (Encabezado)</h3>
                <p style="font-size:0.85rem; color:#64748b; margin-bottom:15px;">Este es el logo horizontal que se ve dentro de la p치gina.</p>
                <div class="logo-preview-container" onclick="document.getElementById('logo-input').click()">
                    <div id="logo-placeholder">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: #cbd5e1; margin-bottom: 10px;"></i>
                        <p style="margin:0; font-weight:600; color:#64748b;">Toca para subir Logo</p>
                    </div>
                    <img id="logo-img-preview" class="current-logo" style="display:none;">
                    <input type="file" id="logo-input" accept="image/*" style="display:none;">
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-university"></i> Datos Generales & Bancarios</h3>
                <form id="config-form">
                    
                    <h4 style="margin-top:0; color:var(--primary); margin-bottom: 15px;">Datos del Administrador</h4>
                    <div class="form-grid">
                        <div>
                            <label>Nombre y Apellido</label>
                            <input type="text" id="conf-nombre-admin" placeholder="Tu nombre">
                        </div>
                        <div>
                            <label>WhatsApp (Soporte)</label>
                            <input type="tel" id="conf-telefono" placeholder="+58...">
                        </div>
                    </div>
                    <hr style="border:0; border-top:1px solid #e2e8f0; margin-bottom:20px;">
                    <div style="margin-bottom: 20px; padding: 15px; background: #f0fdf4; border: 1px dashed #22c55e; border-radius: 12px;">
                        <label style="color: #15803d;">游댕 Enlace Personalizado (Alias)</label>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <span style="font-weight: bold; color: #aaa;">?u=</span>
                            <input type="text" id="conf-alias" placeholder="ej: modas-ana" style="margin:0; text-transform: lowercase; font-weight: bold;" oninput="this.value = this.value.replace(/[^a-z0-9-]/g, '')">
                        </div>
                    </div>

                    <h4 style="margin-top:0; color:var(--primary); margin-bottom: 15px;">Datos Bancarios</h4>
                    <label>Banco</label>
                    <input type="text" id="conf-banco" placeholder="Ej: Banco Venezuela">
                    <div class="form-grid">
                        <div><label>Titular</label><input type="text" id="conf-titular"></div>
                        <div><label>C.I. / RIF</label><input type="text" id="conf-ci"></div>
                    </div>
                    <div class="form-grid">
                        <div><label>Tel칠fono / Cuenta</label><input type="text" id="conf-numero"></div>
                        <div>
                            <label>Tipo</label>
                            <select id="conf-tipo" style="width: 100%; padding: 14px; border: 1px solid var(--border); border-radius: 12px; background: #f8fafc;">
                                <option value="Pago M칩vil">Pago M칩vil</option>
                                <option value="Cuenta Corriente">Cuenta Corriente</option>
                                <option value="Cuenta Ahorro">Cuenta Ahorro</option>
                            </select>
                        </div>
                    </div>
                    <label>C칩digo QR</label>
                    <div class="upload-zone" onclick="document.getElementById('qr-input').click()">
                        <p id="qr-text" style="margin:0; color:#64748b;">Subir imagen QR</p>
                        <img id="qr-preview" style="display:none; max-width:150px; margin-top:10px; border-radius:8px;">
                        <input type="file" id="qr-input" accept="image/*" style="display:none;">
                    </div>
                    <button type="submit" id="btn-save-config" class="btn btn-primary">Guardar Configuraci칩n</button>
                </form>
            </div>
        </div>
        
    <div id="crop-modal">
        <div class="crop-container"><img id="crop-image-target" src=""></div>
        <div class="crop-controls">
            <button onclick="cancelCrop()" class="btn btn-danger" style="width: auto;">Cancelar</button>
            <button onclick="confirmCrop()" class="btn btn-primary" style="width: auto;"><i class="fas fa-crop-alt"></i> Recortar y Guardar</button>
        </div>
    </div>

    <!-- CHAT FUERA DEL DASHBOARD - COMPLETAMENTE INDEPENDIENTE -->
    <div id="chat-interface" class="chat-window">
        <div class="chat-header">
            <button class="btn btn-outline" onclick="closeChat()" style="border: none; padding: 8px;">
                <i class="fas fa-arrow-left"></i>
            </button>
            
            <div id="current-chat-avatar">
                <img src="" class="chat-header-avatar" id="chat-avatar-img">
            </div>
            
            <div class="chat-header-info">
                <div id="current-chat-name">Cliente</div>
                <div id="current-chat-status">En l칤nea</div>
            </div>
            
            <button class="btn btn-outline" onclick="showClientInfo()" title="Informaci칩n del cliente" style="border: none; padding: 8px;">
                <i class="fas fa-info-circle"></i>
            </button>
        </div>
        
        <!-- 츼rea de mensajes -->
        <div class="chat-messages" id="messages-container">
            <!-- Los mensajes se cargan aqu칤 -->
            <div style="text-align: center; padding: 40px 20px; color: rgba(255,255,255,0.5);">
                <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                <p>Inicia la conversaci칩n con tu cliente</p>
                <small style="font-size: 0.8rem;">Los mensajes se sincronizan en tiempo real</small>
            </div>
        </div>
        
        <!-- Indicador de escritura -->
        <div class="typing-indicator" id="typing-indicator"></div>
        
        <!-- 츼rea de entrada fija -->
        <form class="chat-input-area" onsubmit="sendMessage(event)">
            <input type="text" 
                   id="msg-input" 
                   placeholder="Escribe un mensaje..."
                   autocomplete="off">
            <button type="submit" id="send-button">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>

    <script>
        const SUPABASE_URL = 'https://cirrapytmbnjlhxunkaq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpcnJhcHl0bWJuamxoeHVua2FxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NzAyMDAsImV4cCI6MjA3ODU0NjIwMH0.OtJiLGj1EvhPICFaA9ruL02Z9kSQ2jT0t3Smqph81C4';
        
        const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const VAPID_PUBLIC_KEY = "BCkvES3UU5IUHo52kr0VegCslrRYrCo7LcgfJTFAfU-x8g7Ioca5Q-WHU8qyMPDhee6Lbls-l_cjqNQxQuUpoJw";

        let currentUser = null;
        let storeCode = null;
        let currentStoreLogo = null;
        let activeChatClientId = null;
        let activeClientAvatar = null; 
        let activeChannel = null;
        let productsCache = []; 
        let ordersCache = [];
        let editingId = null;
        const notificationSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
        let globalChannel = null;
        let isReconnecting = false;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        let modalCallback = null;
        let galleryFiles = [];

      // --- ONBOARDING LOGIC MODIFICADA ---
function checkOnboarding() {
    if(!currentUser) return;
    
    // Verificar si el usuario ya complet칩 el 100% previamente
    if(localStorage.getItem(`onboardingCompleted_${currentUser.id}`) === 'true') {
        document.getElementById('onboarding-card').style.display = 'none';
        return;
    }
    
    // Paso 1: Productos
    const hasProducts = productsCache.length > 0;
    const step1 = document.getElementById('step-1');
    const btn1 = step1.querySelector('.step-action');
    if(hasProducts) {
        step1.classList.add('done');
        step1.querySelector('.step-icon').innerHTML = '<i class="fas fa-check"></i>';
        btn1.style.display = 'none';
    } else {
        step1.classList.remove('done');
        step1.querySelector('.step-icon').innerHTML = '<i class="fas fa-box"></i>';
        btn1.style.display = 'block';
    }

    // Paso 2: Compartir
    const hasShared = localStorage.getItem(`hasSharedLink_${currentUser.id}`) === 'true';
    const step2 = document.getElementById('step-2');
    const btn2 = step2.querySelector('.step-action');
    if(hasShared) {
        step2.classList.add('done');
        step2.querySelector('.step-icon').innerHTML = '<i class="fas fa-check"></i>';
        btn2.textContent = "Listo";
        btn2.disabled = true;
        btn2.style.background = 'none'; btn2.style.color = '#fff';
    } else {
        step2.classList.remove('done');
        step2.querySelector('.step-icon').innerHTML = '<i class="fas fa-share-alt"></i>';
        btn2.textContent = "Compartir";
        btn2.disabled = false;
    }

    // Paso 3: Ventas
    const hasSales = ordersCache.length > 0;
    const step3 = document.getElementById('step-3');
    if(hasSales) {
        step3.classList.add('done');
        step3.querySelector('.step-icon').innerHTML = '<i class="fas fa-check"></i>';
        step3.querySelector('span:last-child').textContent = "춰Primera venta lograda!";
    } else {
        step3.classList.remove('done');
        step3.querySelector('.step-icon').innerHTML = '<i class="fas fa-star"></i>';
        step3.querySelector('span:last-child').textContent = "Esperando ventas...";
    }

    // Calcular Progreso
    let completed = 0;
    if(hasProducts) completed++;
    if(hasShared) completed++;
    if(hasSales) completed++;
    
    const pct = Math.floor((completed / 3) * 100);
    document.getElementById('ob-progress-fill').style.width = pct + '%';
    document.getElementById('ob-progress-text').textContent = pct + '% Completado';

    // Mostrar/ocultar seg칰n condiciones
    if(pct === 100) {
        // Completado al 100% - Ocultar y marcar como completado permanentemente
        document.getElementById('onboarding-card').style.display = 'none';
        localStorage.setItem(`onboardingCompleted_${currentUser.id}`, 'true');
        document.getElementById('ob-progress-text').textContent = "춰Incre칤ble! 游꿀 Tienda activa.";
    } else {
        // Mostrar solo si no est치 oculto manualmente
        const isManuallyHidden = localStorage.getItem(`hideOnboarding_${currentUser.id}`) === 'true';
        document.getElementById('onboarding-card').style.display = isManuallyHidden ? 'none' : 'block';
    }
}

        function goToAddProduct() {
            switchTab('productos');
            document.getElementById('form-card').scrollIntoView({ behavior: 'smooth' });
            const form = document.getElementById('form-card');
            form.style.border = "2px solid var(--accent)";
            setTimeout(() => form.style.border = "none", 2000);
        }

        function completeShareStep() {
            shareStoreLink();
            localStorage.setItem(`hasSharedLink_${currentUser.id}`, 'true');
            checkOnboarding();
            showToast("춰Paso completado!", "Enlace compartido.");
        }

        // Modificar la funci칩n hideOnboarding para que sea permanente
function hideOnboarding() {
    document.getElementById('onboarding-card').style.display = 'none';
    if(currentUser) {
        localStorage.setItem(`hideOnboarding_${currentUser.id}`, 'true');
        // Tambi칠n marcar como completado para no mostrar m치s
        localStorage.setItem(`onboardingCompleted_${currentUser.id}`, 'true');
    }
    showToast("Gu칤a ocultada", "Puedes reactivarla desde Configuraci칩n si lo necesitas.");
}

        // Funci칩n para reactivar la gu칤a (opcional, si quieres dar la opci칩n)
function resetOnboarding() {
    if(currentUser) {
        localStorage.removeItem(`hideOnboarding_${currentUser.id}`);
        localStorage.removeItem(`onboardingCompleted_${currentUser.id}`);
        localStorage.removeItem(`hasSharedLink_${currentUser.id}`);
        document.getElementById('onboarding-card').style.display = 'block';
        checkOnboarding();
        showToast("Gu칤a reactivada", "La gu칤a de inicio ha sido restablecida.");
    }
}

        // --- SISTEMA DE MODALES PERSONALIZADO ---
        function customConfirm(title, message, type = 'info', callback) {
            const modal = document.getElementById('app-modal');
            const card = document.getElementById('modal-card-content');
            const iconEl = document.getElementById('modal-icon');
            const btnConfirm = document.getElementById('btn-modal-confirm');
            card.className = 'custom-modal-card modal-type-' + type;
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-msg').innerHTML = message;
            let iconClass = 'fa-info-circle';
            if(type === 'success') iconClass = 'fa-check';
            if(type === 'danger') iconClass = 'fa-trash-alt';
            iconEl.innerHTML = `<i class="fas ${iconClass}"></i>`;
            btnConfirm.textContent = type === 'danger' ? 'Eliminar' : 'Confirmar';
            if(type === 'success') btnConfirm.textContent = '춰Si, Entregado!';
            modalCallback = callback;
            modal.classList.add('open');
        }

        function closeCustomModal() {
            document.getElementById('app-modal').classList.remove('open');
            modalCallback = null;
        }

        document.getElementById('btn-modal-confirm').addEventListener('click', () => {
            if (modalCallback) modalCallback();
            closeCustomModal();
        });

        document.getElementById('app-modal').addEventListener('click', (e) => {
            if (e.target.id === 'app-modal') closeCustomModal();
        });

        // --- FUNCIONES PUSH ---
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
            return outputArray;
        }

        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    return registration;
                } catch (error) { console.error('Error SW:', error); }
            }
        }

        async function subscribeUser() {
            const registration = await registerServiceWorker();
            if (!registration) return;
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
            });
            if (currentUser) {
                const subData = JSON.parse(JSON.stringify(subscription));
                await _supabase.from('push_subscriptions').upsert({
                    user_id: currentUser.id,
                    endpoint: subData.endpoint,
                    p256dh: subData.keys.p256dh,
                    auth: subData.keys.auth
                }, { onConflict: 'endpoint' });
            }
        }

        // --- AUTH Y CARGA ---
        _supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                currentUser = session.user;
                initAdmin(session.user);
                setTimeout(registerServiceWorker, 1000);
            } else {
                document.getElementById('login-container').style.display = 'block';
                document.getElementById('dashboard').style.display = 'none';
            }
        });

        async function initAdmin(user) {
            let { data: userData } = await _supabase.from('usuarios').select('*').eq('id', user.id).single();
            if (!userData) {
                userData = { id: user.id, email: user.email, nombre: 'Admin', rol: 'due침o' };
                await _supabase.from('usuarios').insert(userData);
            }
            storeCode = userData.codigo_tienda || 'TIENDA-' + Math.random().toString(36).substring(2, 6).toUpperCase();
            if (!userData.codigo_tienda) await _supabase.from('usuarios').update({ codigo_tienda: storeCode }).eq('id', user.id);

            document.getElementById('store-code-display').textContent = "C칍DIGO: " + storeCode;
            currentStoreLogo = userData.logo_url || 'https://cdn-icons-png.flaticon.com/512/1041/1041888.png';

            document.getElementById('login-container').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            await loadProducts();
            await loadOrders();
            checkOnboarding();
            
            updateDashboardCounters();
            setTimeout(() => setupGlobalRealtime(), 2000);
        }

        let isLoginMode = true;

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            const title = document.getElementById('auth-title');
            const btn = document.getElementById('btn-auth-action');
            const toggleText = document.getElementById('toggle-text');
            const toggleBtn = document.getElementById('btn-toggle-auth');
            const msg = document.getElementById('auth-msg');

            msg.textContent = '';

            if (isLoginMode) {
                title.textContent = "Admin Access";
                btn.textContent = "Ingresar";
                toggleText.textContent = "쯅o tienes cuenta?";
                toggleBtn.textContent = "Crear Tienda";
            } else {
                title.textContent = "Crear Nueva Tienda";
                btn.textContent = "Registrarme";
                toggleText.textContent = "쯏a tienes cuenta?";
                toggleBtn.textContent = "Iniciar Sesi칩n";
            }
        }

        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const msg = document.getElementById('auth-msg');
            const btn = document.getElementById('btn-auth-action');
            const originalBtnText = btn.textContent;

            if (password.length < 6) {
                msg.textContent = "La contrase침a debe tener al menos 6 caracteres.";
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
            msg.textContent = "";

            try {
                let result;
                if (isLoginMode) {
                    result = await _supabase.auth.signInWithPassword({ email, password });
                } else {
                    result = await _supabase.auth.signUp({ email, password });
                }

                if (result.error) throw result.error;

                if (!isLoginMode && result.data.user && !result.data.session) {
                    msg.style.color = '#22c55e';
                    msg.textContent = "춰Registro exitoso! Revisa tu correo para confirmar.";
                    btn.disabled = false;
                    btn.textContent = originalBtnText;
                    return;
                }
            } catch (error) {
                msg.style.color = 'var(--accent)'; 
                msg.textContent = "Error: " + (error.message === "Invalid login credentials" ? "Credenciales incorrectas" : error.message);
                btn.disabled = false;
                btn.textContent = originalBtnText;
            }
        });

        async function logout() {
            if (globalChannel) await _supabase.removeChannel(globalChannel);
            await _supabase.auth.signOut(); window.location.reload();
        }

        // --- REALTIME ---
        async function setupGlobalRealtime() {
            if (globalChannel && ['SUBSCRIBED', 'JOINED'].includes(globalChannel.state)) return;
            if (globalChannel) await _supabase.removeChannel(globalChannel);
            
            globalChannel = _supabase.channel(`admin-global-${currentUser.id}-${Date.now()}`)
            .on('postgres_changes', { 
                event: 'INSERT', 
                schema: 'public', 
                table: 'mensajes', 
                filter: `tienda_id=eq.${currentUser.id}` 
            }, payload => {
                if(payload.new.tienda_id != currentUser.id) return;
                if(payload.new.enviado_por_rol === 'cliente') {
                    const incomingClientId = String(payload.new.cliente_id);
                    const currentChatId = String(activeChatClientId);
                    if (currentChatId !== incomingClientId) { 
                        showToast('Nuevo Mensaje', 'Cliente envi칩 mensaje'); 
                        updateDashboardCounters(); 
                    }
                }
                if(document.getElementById('tab-chats').classList.contains('active')) loadChatsList();
                const incomingClientId = String(payload.new.cliente_id);
                if (activeChatClientId && incomingClientId === String(activeChatClientId) && payload.new.enviado_por_rol !== 'due침o') {
                    renderMessage(payload.new);
                }
            })
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'pedidos' }, (payload) => {
                if (payload.new.tienda_id !== currentUser.id) return; 
                showToast('Nuevo Pedido', '춰Revisa la lista!'); 
                updateDashboardCounters();
                if(document.getElementById('tab-pedidos').classList.contains('active')) loadOrders();
                checkOnboarding();
            })
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') { 
                    isReconnecting = false; 
                    reconnectAttempts = 0;
                    document.getElementById('store-code-display').style.borderColor = '#22c55e'; 
                }
                else if (status === 'TIMED_OUT' || status === 'CLOSED' || status === 'CHANNEL_ERROR') { 
                    if (!isReconnecting && reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        handleConnectionDrop(); 
                    }
                }
            });
        }
        
        function handleConnectionDrop() {
            if (isReconnecting) return; 
            isReconnecting = true;
            reconnectAttempts++;
            
            document.getElementById('store-code-display').style.borderColor = '#ef4444'; 
            console.log(`Intento de reconexi칩n ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS}`);
            
            const delay = Math.min(1000 * reconnectAttempts, 10000); // Retorno exponencial
            
            setTimeout(() => { 
                if (currentUser) {
                    setupGlobalRealtime(); 
                }
            }, delay);
        }

        // --- SHARE STORE LINK ---
        async function shareStoreLink() {
            const aliasInput = document.getElementById('conf-alias').value.trim();
            const identifier = aliasInput || storeCode || currentUser.id; 
            const domain = window.location.origin;
            const shareUrl = `${domain}/tienda/${identifier}`;
            const storeName = document.getElementById('conf-pwa-nombre').value || 'Mi Tienda Online';

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: storeName,
                        text: `춰Hola! Visita mi tienda online ${storeName} y mira el cat치logo completo:`,
                        url: shareUrl
                    });
                    showToast("Compartido", "Enlace de tienda compartido.");
                } catch (err) {
                    console.log(err);
                }
            } else {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showToast("Copiado", "Enlace copiado al portapapeles.");
                });
            }

            localStorage.setItem(`hasSharedLink_${currentUser.id}`, 'true');
            checkOnboarding();
        }

        function copyCode() { navigator.clipboard.writeText(storeCode); showToast("C칩digo Copiado", storeCode); }

        // --- GALER칈A DE IM츼GENES ---
        document.getElementById('imagen-input').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const totalCurrent = galleryFiles.length;
            const available = 6 - totalCurrent;
            if (files.length > available) { showToast("L칤mite Excedido", "M치ximo 6 fotos en total."); }
            const filesToAdd = files.slice(0, available);
            filesToAdd.forEach(file => { galleryFiles.push({ type: 'file', data: file }); });
            renderGalleryPreview();
            this.value = '';
        });

        function renderGalleryPreview() {
            const container = document.getElementById('gallery-preview-container');
            container.innerHTML = '';
            galleryFiles.forEach((item, index) => {
                const div = document.createElement('div'); div.className = 'gallery-item';
                const img = document.createElement('img');
                if (item.type === 'file') { img.src = URL.createObjectURL(item.data); } else { img.src = item.data; }
                const btn = document.createElement('button'); btn.className = 'btn-remove-img'; btn.innerHTML = '<i class="fas fa-times"></i>';
                btn.onclick = (e) => { e.preventDefault(); removeImageFromGallery(index); };
                div.appendChild(img); div.appendChild(btn); container.appendChild(div);
            });
        }

        function removeImageFromGallery(index) {
            galleryFiles.splice(index, 1);
            renderGalleryPreview();
        }

        // --- PRODUCTOS ---
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault(); 
            if(galleryFiles.length === 0) { showToast("Falta Imagen", "Sube al menos una foto."); return; }
            const btn = document.getElementById('btn-save'); btn.textContent = "Guardando..."; btn.disabled = true;
            
            try {
                let uploadedUrls = [];
                for (const item of galleryFiles) {
                    if (item.type === 'url') {
                        uploadedUrls.push(item.data);
                    } else if (item.type === 'file') {
                        const file = item.data;
                        const fileName = `${currentUser.id}/${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                        const { error: uploadErr } = await _supabase.storage.from('imagenes-productos').upload(fileName, file);
                        if (uploadErr) throw uploadErr;
                        const { data } = _supabase.storage.from('imagenes-productos').getPublicUrl(fileName);
                        uploadedUrls.push(data.publicUrl);
                    }
                }
                const mainImage = uploadedUrls[0];
                const productData = {
                    nombre: document.getElementById('nombre').value,
                    precio: parseFloat(document.getElementById('precio').value),
                    descripcion: document.getElementById('descripcion').value,
                    marca: document.getElementById('marca').value.trim(),
                    stock: parseInt(document.getElementById('stock').value),
                    categoria: document.getElementById('categoria').value,
                    destacado: document.getElementById('destacado').checked,
                    creado_por: currentUser.id,
                    imagen_url: mainImage,
                    galeria: uploadedUrls
                };
                if (editingId) { await _supabase.from('productos').update(productData).eq('id', editingId); } 
                else { await _supabase.from('productos').insert([productData]); }
                resetForm(); loadProducts(); showToast("칄xito", "Producto guardado con fotos.");
                checkOnboarding();
            } catch (error) { alert("Error: " + error.message); } 
            finally { btn.disabled = false; btn.textContent = "Publicar"; }
        });

        function resetForm() {
            document.getElementById('product-form').reset(); editingId = null; galleryFiles = []; renderGalleryPreview();
            document.getElementById('btn-save').textContent = "Publicar";
            document.getElementById('btn-cancel').style.display = 'none';
            document.getElementById('form-title').innerHTML = '<i class="fas fa-plus-circle"></i> Nuevo Producto';
        }

        async function loadProducts() {
            const { data } = await _supabase.from('productos').select('*').eq('creado_por', currentUser.id).order('id', {ascending:false});
            productsCache = data || []; updateCategoryDatalist(); 
            const table = document.getElementById('products-table');
            if(!data || data.length === 0) { table.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">Sin productos.</td></tr>'; checkOnboarding(); return; }
            table.innerHTML = `<thead><tr><th>FOTO</th><th>DETALLE</th><th>$</th><th>ACCIONES</th></tr></thead><tbody>${data.map(p => `<tr><td><img src="${p.imagen_url || 'https://via.placeholder.com/50'}" class="product-img"></td><td><div style="font-weight:600; font-size:0.9rem;">${p.nombre}</div><div style="font-size:0.75rem; color:#94a3b8;">Stock: ${p.stock}</div></td><td style="font-weight:bold;">${p.precio}</td><td><button class="btn-icon btn-edit" onclick="startEdit(${p.id})"><i class="fas fa-pen"></i></button><button class="btn-icon btn-danger" onclick="deleteProduct(${p.id})"><i class="fas fa-trash"></i></button></td></tr>`).join('')}</tbody>`;
            checkOnboarding();
        }

        function startEdit(id) {
            const p = productsCache.find(x => x.id === id); if(!p) return;
            editingId = id;
            document.getElementById('nombre').value = p.nombre; document.getElementById('precio').value = p.precio;
            document.getElementById('descripcion').value = p.descripcion || ''; document.getElementById('stock').value = p.stock;
            document.getElementById('marca').value = p.marca || '';
            document.getElementById('categoria').value = p.categoria || ''; document.getElementById('destacado').checked = p.destacado;
            galleryFiles = [];
            if (p.galeria && Array.isArray(p.galeria) && p.galeria.length > 0) {
                p.galeria.forEach(url => { galleryFiles.push({ type: 'url', data: url }); });
            } else if (p.imagen_url) { galleryFiles.push({ type: 'url', data: p.imagen_url }); }
            renderGalleryPreview();
            document.getElementById('form-title').innerHTML = '<i class="fas fa-edit"></i> Editando Producto';
            document.getElementById('btn-save').textContent = "Actualizar";
            document.getElementById('btn-cancel').style.display = 'inline-block';
            document.getElementById('form-card').scrollIntoView({ behavior: 'smooth' });
        }

        async function deleteProduct(id) { 
            customConfirm("쮼liminar Producto?", "Esta acci칩n borrar치 el producto permanentemente del cat치logo.", "danger",
                async () => { await _supabase.from('productos').delete().eq('id', id); loadProducts(); showToast("Eliminado", "Producto borrado correctamente"); }
            );
        }

        // --- PEDIDOS ---
        let showingHistory = false; 
        async function loadOrders() {
            const { data } = await _supabase.from('pedidos').select('*, clientes(nombre, telefono)').eq('tienda_id', currentUser.id).order('fecha', {ascending:false});
            ordersCache = data || []; updateDashboardCounters(); renderOrders();
            checkOnboarding();
        }

        function renderOrders() {
            const list = document.getElementById('orders-list');
            const visibleOrders = showingHistory ? ordersCache : ordersCache.filter(o => o.estado === 'pendiente');
            let html = `<div style="margin-bottom:15px; text-align:right;"><button onclick="toggleHistory()" class="btn btn-outline" style="font-size:0.8rem; padding: 5px 10px;">${showingHistory ? '<i class="fas fa-eye-slash"></i> Ocultar Completados' : '<i class="fas fa-history"></i> Ver Historial'}</button></div>`;
            if(visibleOrders.length === 0) { list.innerHTML = html + `<div style="text-align:center; padding:40px; color:#94a3b8;">No hay pedidos pendientes.</div>`; return; }
            html += visibleOrders.map(o => {
                let itemsArray = []; if (o.productos && o.productos.items) itemsArray = o.productos.items; else if (Array.isArray(o.productos)) itemsArray = o.productos;
                const productsHTML = itemsArray.length > 0 ? itemsArray.map(i => i.name).join(', ') : 'Sin detalle';
                const actionBtn = o.estado === 'pendiente' ? `<button onclick="completeOrder(${o.id})" class="btn btn-primary" style="padding: 10px; margin-top:12px; background:#22c55e;"><i class="fas fa-check"></i> DESPACHAR</button>` : `<div style="margin-top:10px; padding:8px; background:#f0fdf4; color:#15803d; border-radius:8px; text-align:center; font-size:0.85rem;"><i class="fas fa-check-double"></i> Entregado</div>`;
                return `<div class="order-item" style="border-left: 4px solid ${o.estado === 'pendiente' ? '#f97316' : '#22c55e'};"><div style="display:flex; justify-content:space-between;"><div style="font-weight:600;">${o.clientes?.nombre || 'Cliente'}</div><span class="badge-pending">${o.estado.toUpperCase()}</span></div><div style="font-size:0.85rem; color:#64748b; margin-top:5px;">${productsHTML}</div><div style="display:flex; justify-content:space-between; margin-top:10px; font-weight:bold;"><span>$${o.total}</span> <small>${new Date(o.fecha).toLocaleDateString()}</small></div>${actionBtn}</div>`;
            }).join('');
            list.innerHTML = html;
        }
        
        function toggleHistory() { showingHistory = !showingHistory; renderOrders(); }
        
        async function completeOrder(orderId) {
            customConfirm("쮺onfirmar Entrega?", "쮺onfirmas que recibiste el dinero y entregaste el producto?", "success", 
                async () => {
                    const order = ordersCache.find(o => o.id === orderId); if(!order) return;
                    let items = []; if (order.productos && order.productos.items) items = order.productos.items; else if (Array.isArray(order.productos)) items = order.productos;
                    try {
                        for (const item of items) { 
                            const { data: curr } = await _supabase.from('productos').select('stock').eq('id', item.id).single(); 
                            if (curr) await _supabase.from('productos').update({ stock: curr.stock - 1 }).eq('id', item.id); 
                        }
                        await _supabase.from('pedidos').update({ estado: 'completado' }).eq('id', orderId); 
                        showToast("춰Venta Registrada!", "Sumado al resumen.");
                        loadOrders(); loadSummary(); loadProducts();
                    } catch (e) { showToast("Error", e.message); }
                }
            );
        }

        async function loadSummary() {
            const { data: orders, error } = await _supabase.from('pedidos').select('total, fecha, cliente_id, clientes(nombre)').eq('tienda_id', currentUser.id).eq('estado', 'completado').order('fecha', { ascending: false });
            if (error) { console.error(error); return; }
            let totalIncome = 0; let totalCount = orders.length; const clientMap = {}; 
            orders.forEach(o => {
                const amount = parseFloat(o.total); totalIncome += amount;
                const cId = o.cliente_id; const cName = o.clientes ? o.clientes.nombre : 'Desconocido';
                if (!clientMap[cId]) { clientMap[cId] = { name: cName, total: 0, orders: 0 }; }
                clientMap[cId].total += amount; clientMap[cId].orders += 1;
            });
            let topClientName = "Nadie a칰n"; let topClientAmount = 0;
            const sortedClients = Object.values(clientMap).sort((a, b) => b.total - a.total);
            if (sortedClients.length > 0) { topClientName = sortedClients[0].name; topClientAmount = sortedClients[0].total; }
            document.getElementById('stat-income').textContent = `$${totalIncome.toFixed(2)}`;
            document.getElementById('stat-orders').textContent = totalCount;
            document.getElementById('stat-top-client').textContent = topClientName;
            document.getElementById('stat-top-spent').textContent = `Ha comprado: $${topClientAmount.toFixed(2)}`;
            const recentBody = document.getElementById('recent-sales-body');
            if(orders.length === 0) { recentBody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:15px; color:#94a3b8;">Sin ventas registradas</td></tr>'; } 
            else { recentBody.innerHTML = orders.slice(0, 5).map(o => `<tr><td>${o.clientes?.nombre || 'Anon'}</td><td style="color:#22c55e; font-weight:bold;">+$${o.total}</td><td style="color:#64748b; font-size:0.85rem;">${new Date(o.fecha).toLocaleDateString()}</td></tr>`).join(''); }
        }

        // --- UI & CHATS ---
        function showToast(title, message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div'); toast.className = 'toast-notification';
            toast.innerHTML = `<i class="fas fa-bell"></i><div class="toast-content"><div>${title}</div><small>${message}</small></div>`;
            container.appendChild(toast); try { notificationSound.play().catch(()=>{}); } catch(e){}
            setTimeout(() => { toast.remove(); }, 4000);
        }
        
        async function updateDashboardCounters() {
            const { count: unreadMsgs } = await _supabase.from('mensajes').select('*', { count: 'exact', head: true }).eq('tienda_id', currentUser.id).eq('leido', false).eq('enviado_por_rol', 'cliente');
            const { count: pendingOrders } = await _supabase.from('pedidos').select('*', { count: 'exact', head: true }).eq('estado', 'pendiente'); 
            const bChat = document.getElementById('badge-chats'); const bOrd = document.getElementById('badge-orders');
            bChat.textContent = unreadMsgs; bChat.style.display = unreadMsgs > 0 ? 'block' : 'none';
            bOrd.textContent = pendingOrders; bOrd.style.display = pendingOrders > 0 ? 'block' : 'none';
        }
        
        function switchTab(t) {
            // Si hay un chat abierto, cerrarlo primero
            const chatWindow = document.getElementById('chat-interface');
            if (chatWindow.classList.contains('active') || chatWindow.style.display === 'flex') {
                closeChat();
                // Peque침o delay para que se cierre antes de cambiar de tab
                setTimeout(() => {
                    actuallySwitchTab(t);
                }, 100);
            } else {
                actuallySwitchTab(t);
            }
        }

        function actuallySwitchTab(t) {
            document.querySelectorAll('.panel-section').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
            const btn = event.target.closest('.tab'); 
            if(btn) btn.classList.add('active');
            
            if(t === 'chats') loadChatsList(); 
            if(t === 'pedidos') loadOrders(); 
            if(t === 'config') loadConfig(); 
            if(t === 'resumen') loadSummary();
        }

        // --- FUNCI칍N MEJORADA PARA CARGAR LISTA DE CONTACTOS ---
        async function loadChatsList() {
            try {
                console.log('游 Cargando lista de contactos...');
                
                // 1. Obtener todos los mensajes
                const { data: messages, error: msgError } = await _supabase
                    .from('mensajes')
                    .select('*')
                    .eq('tienda_id', currentUser.id)
                    .order('created_at', { ascending: false });
                    
                if (msgError) throw msgError;
                
                if (!messages || messages.length === 0) {
                    document.getElementById('contacts-grid').innerHTML = `
                        <div class="no-contacts" style="text-align: center; padding: 60px 20px; color: #94a3b8;">
                            <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                            <h4 style="margin: 10px 0;">No hay conversaciones activas</h4>
                            <p style="margin: 0; font-size: 0.9rem;">Cuando los clientes te escriban, aparecer치n aqu칤 organizados por contacto.</p>
                        </div>`;
                    return;
                }
                
                // 2. Identificar clientes 칰nicos
                const clientIds = [...new Set(messages.map(m => m.cliente_id))];
                console.log(`游논 ${clientIds.length} clientes 칰nicos encontrados`);
                
                // 3. Obtener datos de clientes
                const { data: clientes, error: clientError } = await _supabase
                    .from('clientes')
                    .select('*')
                    .in('id', clientIds);
                    
                if (clientError) throw clientError;
                
                // 4. Contar mensajes no le칤dos
                const { data: unreadMsgs } = await _supabase
                    .from('mensajes')
                    .select('cliente_id')
                    .eq('tienda_id', currentUser.id)
                    .eq('enviado_por_rol', 'cliente')
                    .eq('leido', false);
                    
                const unreadCounts = {};
                if (unreadMsgs) {
                    unreadMsgs.forEach(msg => {
                        unreadCounts[msg.cliente_id] = (unreadCounts[msg.cliente_id] || 0) + 1;
                    });
                }
                
                // 5. Crear lista de contactos
                const contacts = clientIds.map(clientId => {
                    // Mensajes de este cliente
                    const clientMessages = messages.filter(m => m.cliente_id === clientId);
                    const lastMsg = clientMessages[0]; // El m치s reciente
                    
                    // Datos del cliente
                    const clienteData = (clientes || []).find(c => c.id === clientId) || {};
                    
                    // Nombre del cliente
                    let clientName = clienteData.nombre || 'Cliente';
                    if (clienteData.telefono) {
                        clientName = clienteData.nombre || `Cliente ${clienteData.telefono.slice(-4)}`;
                    }
                    
                    // Avatar
                    let avatar = clienteData.foto_b64 || 
                        `https://ui-avatars.com/api/?name=${encodeURIComponent(clientName)}&background=6366f1&color=fff`;
                    
                    return {
                        id: clientId,
                        name: clientName,
                        avatar: avatar,
                        phone: clienteData.telefono || 'Sin tel칠fono',
                        lastMessage: lastMsg?.contenido || '',
                        lastMessageTime: lastMsg?.created_at || new Date(),
                        isLastFromMe: lastMsg?.enviado_por_rol === 'due침o',
                        unreadCount: unreadCounts[clientId] || 0,
                        totalMessages: clientMessages.length,
                        lastActivity: lastMsg?.created_at
                    };
                });
                
                // 6. Ordenar por actividad reciente
                contacts.sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));
                
                console.log(`九 Lista de contactos procesada:`, contacts.map(c => ({ 
                    nombre: c.name, 
                    mensajes: c.totalMessages,
                    noLeidos: c.unreadCount 
                })));
                
                // 7. Renderizar
                renderContacts(contacts);
                
            } catch (error) {
                console.error('仇 Error cargando contactos:', error);
                document.getElementById('contacts-grid').innerHTML = `
                    <div class="no-contacts" style="text-align: center; padding: 60px 20px; color: #94a3b8;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h4 style="margin: 10px 0;">Error al cargar contactos</h4>
                        <p style="margin: 0; font-size: 0.9rem;">${error.message || 'Intenta recargar la p치gina.'}</p>
                        <button onclick="loadChatsList()" class="btn btn-outline" style="margin-top: 15px;">
                            <i class="fas fa-sync-alt"></i> Reintentar
                        </button>
                    </div>`;
            }
        }

        function renderContacts(contacts) {
            const grid = document.getElementById('contacts-grid');
            
            if (!contacts || contacts.length === 0) {
                grid.innerHTML = `
                    <div class="no-contacts" style="text-align: center; padding: 60px 20px; color: #94a3b8;">
                        <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h4 style="margin: 10px 0;">No hay conversaciones activas</h4>
                        <p style="margin: 0; font-size: 0.9rem;">Cuando los clientes te escriban, aparecer치n aqu칤 organizados por contacto.</p>
                    </div>`;
                return;
            }

            // Limpiar completamente el grid y configurar su estilo
            grid.innerHTML = '';
            grid.style.display = 'flex';
            grid.style.flexDirection = 'column';
            grid.style.gap = '12px';
            grid.style.padding = '15px';
            grid.style.width = '100%';
            grid.style.boxSizing = 'border-box';
            grid.style.overflowY = 'auto';
            grid.style.flex = '1';

            // Renderizar cada contacto
            contacts.forEach((contact, index) => {
                // Formatear tiempo
                let timeDisplay = 'Ahora';
                if (contact.lastMessageTime) {
                    const msgDate = new Date(contact.lastMessageTime);
                    const now = new Date();
                    const diffMs = now - msgDate;
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMs / 3600000);
                    const diffDays = Math.floor(diffMs / 86400000);
                    
                    if (diffMins < 60) {
                        timeDisplay = `${diffMins} min`;
                    } else if (diffHours < 24) {
                        timeDisplay = `${diffHours} h`;
                    } else if (diffDays < 7) {
                        timeDisplay = `${diffDays} d`;
                    } else {
                        timeDisplay = msgDate.toLocaleDateString([], { month: 'short', day: 'numeric' });
                    }
                }
                
                // Vista previa del mensaje
                let preview = contact.lastMessage || 'Sin mensajes';
                if (preview.length > 60) {
                    preview = preview.substring(0, 57) + '...';
                }
                preview = preview.replace(/<[^>]*>/g, '');
                
                // Crear la tarjeta de contacto
                const contactCard = document.createElement('div');
                contactCard.className = 'contact-card';
                contactCard.style.cssText = `
                    background: ${contact.unreadCount > 0 ? '#f0f9ff' : 'white'};
                    border: 1px solid ${contact.unreadCount > 0 ? '#bae6fd' : '#e2e8f0'};
                    border-radius: 12px;
                    padding: 15px;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    width: 100%;
                    box-sizing: border-box;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    position: relative;
                `;
                
                // Efectos hover
                contactCard.onmouseenter = () => {
                    contactCard.style.transform = 'translateY(-2px)';
                    contactCard.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
                    contactCard.style.borderColor = '#6366f1';
                };
                contactCard.onmouseleave = () => {
                    contactCard.style.transform = 'translateY(0)';
                    contactCard.style.boxShadow = 'none';
                    contactCard.style.borderColor = contact.unreadCount > 0 ? '#bae6fd' : '#e2e8f0';
                };
                
                // Click para abrir chat
                contactCard.onclick = () => {
                    openChat(contact.id, contact.name, contact.avatar);
                };
                
                // N칰mero del contacto (para depuraci칩n)
                const numberBadge = document.createElement('div');
                numberBadge.textContent = (index + 1).toString();
                numberBadge.style.cssText = `
                    position: absolute;
                    top: 5px;
                    left: 5px;
                    background: #6366f1;
                    color: white;
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 11px;
                    font-weight: bold;
                    z-index: 10;
                `;
                contactCard.appendChild(numberBadge);
                
                // Avatar
                const avatarImg = document.createElement('img');
                avatarImg.src = contact.avatar;
                avatarImg.alt = contact.name;
                avatarImg.style.cssText = `
                    width: 50px;
                    height: 50px;
                    border-radius: 50%;
                    object-fit: cover;
                    border: 2px solid white;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    flex-shrink: 0;
                `;
                avatarImg.onerror = () => {
                    avatarImg.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(contact.name)}&background=6366f1&color=fff`;
                };
                
                // Contenedor de informaci칩n
                const infoDiv = document.createElement('div');
                infoDiv.style.cssText = `
                    flex: 1;
                    min-width: 0;
                    display: flex;
                    flex-direction: column;
                `;
                
                // Fila del nombre y tiempo
                const nameRow = document.createElement('div');
                nameRow.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 4px;
                `;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = contact.name;
                nameSpan.style.cssText = `
                    font-weight: 700;
                    font-size: 0.95rem;
                    color: #1e293b;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    max-width: 150px;
                `;
                
                const timeSpan = document.createElement('span');
                timeSpan.textContent = timeDisplay;
                timeSpan.style.cssText = `
                    font-size: 0.75rem;
                    color: #94a3b8;
                    font-weight: 500;
                `;
                
                nameRow.appendChild(nameSpan);
                nameRow.appendChild(timeSpan);
                
                // Vista previa del mensaje
                const previewDiv = document.createElement('div');
                previewDiv.textContent = (contact.isLastFromMe ? '九 ' : '') + preview;
                previewDiv.style.cssText = `
                    font-size: 0.85rem;
                    color: #64748b;
                    line-height: 1.4;
                    display: -webkit-box;
                    -webkit-line-clamp: 2;
                    -webkit-box-orient: vertical;
                    overflow: hidden;
                    text-overflow: ellipsis;
                `;
                
                infoDiv.appendChild(nameRow);
                infoDiv.appendChild(previewDiv);
                
                // Estad칤sticas
                const statsDiv = document.createElement('div');
                statsDiv.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    align-items: flex-end;
                    gap: 4px;
                    flex-shrink: 0;
                `;
                
                // Contador de mensajes
                const msgCount = document.createElement('div');
                msgCount.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 4px;
                `;
                msgCount.innerHTML = `<i class="fas fa-comment" style="font-size: 0.8rem; color: #94a3b8;"></i>
                                      <span style="font-size: 0.75rem; color: #64748b; font-weight: 600;">${contact.totalMessages}</span>`;
                
                statsDiv.appendChild(msgCount);
                
                // Badge de no le칤dos si aplica
                if (contact.unreadCount > 0) {
                    const unreadBadge = document.createElement('div');
                    unreadBadge.style.cssText = `
                        background: #ef4444;
                        color: white;
                        font-size: 0.7rem;
                        font-weight: bold;
                        padding: 2px 6px;
                        border-radius: 10px;
                        display: flex;
                        align-items: center;
                        gap: 3px;
                    `;
                    unreadBadge.innerHTML = `<i class="fas fa-bell" style="font-size: 0.6rem;"></i><span>${contact.unreadCount}</span>`;
                    statsDiv.appendChild(unreadBadge);
                }
                
                // Ensamblar la tarjeta
                contactCard.appendChild(avatarImg);
                contactCard.appendChild(infoDiv);
                contactCard.appendChild(statsDiv);
                
                // Agregar al grid
                grid.appendChild(contactCard);
            });
            
            // Agregar contador de contactos
            const counterDiv = document.createElement('div');
            counterDiv.style.cssText = `
                text-align: center;
                padding: 15px;
                color: #64748b;
                font-size: 0.85rem;
                border-top: 1px solid #e2e8f0;
                margin-top: 10px;
            `;
            counterDiv.innerHTML = `<i class="fas fa-users"></i> ${contacts.length} contactos en total`;
            grid.appendChild(counterDiv);
            
            console.log(`九 Renderizados ${contacts.length} contactos correctamente`);
        }

        function filterContacts() {
            const searchTerm = document.getElementById('chats-search').value.toLowerCase().trim();
            const cards = document.querySelectorAll('#contacts-grid .contact-card');
            
            if (!cards.length) return;
            
            let visibleCount = 0;
            cards.forEach(card => {
                const nameElement = card.querySelector('span[style*="font-weight: 700"]');
                const name = nameElement ? nameElement.textContent.toLowerCase() : '';
                
                const previewElement = card.querySelector('div[style*="font-size: 0.85rem"]');
                const preview = previewElement ? previewElement.textContent.toLowerCase() : '';
                
                if (name.includes(searchTerm) || preview.includes(searchTerm)) {
                    card.style.display = 'flex';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            const counterDiv = document.querySelector('#contacts-grid div[style*="text-align: center"]');
            if (counterDiv) {
                counterDiv.innerHTML = `<i class="fas fa-users"></i> ${visibleCount} de ${cards.length} contactos`;
            }
        }


async function openChat(clientId, clientName, clientAvatarSrc) {
    console.log('游님 Abriendo chat en pantalla completa con:', clientName);
    
    // --- CORRECCI칍N AQU칈 ---
    // NO ocultes el dashboard. Esto causaba la pantalla blanca.
    // document.getElementById('dashboard').style.display = 'none'; 
    
    // Mostrar el chat
    const chatWindow = document.getElementById('chat-interface');
    chatWindow.style.display = 'flex';
    
    // Usamos requestAnimationFrame para asegurar que la animaci칩n
    // ocurra DESPU칄S de que el elemento sea visible.
    requestAnimationFrame(() => {
        chatWindow.classList.add('active');
    });
    
    activeChatClientId = clientId;
    activeClientAvatar = clientAvatarSrc || `https://ui-avatars.com/api/?name=${encodeURIComponent(clientName)}&background=005c4b&color=fff`;
    
    // Actualizar header del chat
    document.getElementById('current-chat-name').textContent = clientName;
    document.getElementById('chat-avatar-img').src = activeClientAvatar;
    document.getElementById('current-chat-status').textContent = 'Conectado';
    
    // Cargar historial de mensajes
    await loadChatHistory(clientId);
    
    // Marcar mensajes como le칤dos
    await markMessagesAsRead(clientId);
    
    // Configurar canal en tiempo real
    setupChatRealtime(clientId);
    
    // Enfocar el campo de entrada
    setTimeout(() => {
        document.getElementById('msg-input').focus();
    }, 500);
    
    // Actualizar contadores
    updateDashboardCounters();
}
        

        async function loadChatHistory(clientId) {
            try {
                const { data } = await _supabase.from('mensajes').select('*')
                    .eq('tienda_id', currentUser.id)
                    .eq('cliente_id', clientId)
                    .order('created_at', { ascending: true });
                
                const container = document.getElementById('messages-container');
                container.innerHTML = '';
                
                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: rgba(255,255,255,0.5);">
                            <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                            <p>No hay mensajes a칰n</p>
                            <small style="font-size: 0.8rem;">Env칤a el primer mensaje</small>
                        </div>`;
                    return;
                }
                
                data.forEach(msg => {
                    renderMessage(msg);
                });
                
                // Scroll al final
                container.scrollTop = container.scrollHeight;
                
            } catch (error) {
                console.error('Error cargando historial:', error);
            }
        }

        function renderMessage(msg) {
            const isMe = msg.enviado_por_rol === 'due침o';
            const avatarUrl = isMe 
                ? (currentStoreLogo || 'https://cdn-icons-png.flaticon.com/512/1041/1041888.png') 
                : (activeClientAvatar || `https://ui-avatars.com/api/?name=Cliente&background=202c33&color=fff`);
            
            const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const divRow = document.createElement('div');
            divRow.className = `msg-row ${isMe ? 'me' : 'them'}`;
            divRow.style.animation = 'fadeIn 0.3s ease';
            
            let content = msg.contenido || '';
            
            // Detectar si es imagen
            if (content.includes('<img')) {
                divRow.innerHTML = `
                    <img src="${avatarUrl}" class="msg-avatar">
                    <div class="msg-bubble">
                        ${content}
                        <span class="msg-time">${time}</span>
                    </div>
                `;
            } else {
                // Formatear texto normal
                const textContent = content.replace(/\n/g, '<br>');
                divRow.innerHTML = `
                    <img src="${avatarUrl}" class="msg-avatar">
                    <div class="msg-bubble">
                        ${textContent}
                        <span class="msg-time">${time}</span>
                    </div>
                `;
            }
            
            const container = document.getElementById('messages-container');
            container.appendChild(divRow);
            
            // Scroll autom치tico solo para nuevos mensajes
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        async function markMessagesAsRead(clientId) {
            try {
                await _supabase.from('mensajes').update({ leido: true })
                    .eq('cliente_id', clientId)
                    .eq('tienda_id', currentUser.id)
                    .eq('enviado_por_rol', 'cliente')
                    .eq('leido', false);
            } catch (error) {
                console.error('Error marcando mensajes como le칤dos:', error);
            }
        }

        function setupChatRealtime(clientId) {
            if (activeChannel) {
                _supabase.removeChannel(activeChannel);
            }
            
            activeChannel = _supabase.channel(`chat_${currentUser.id}_${clientId}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'mensajes',
                    filter: `cliente_id=eq.${clientId}`
                }, payload => {
                    if (payload.new.tienda_id === currentUser.id) {
                        renderMessage(payload.new);
                        
                        // Marcar como le칤do autom치ticamente
                        if (payload.new.enviado_por_rol === 'cliente') {
                            _supabase.from('mensajes').update({ leido: true })
                                .eq('id', payload.new.id);
                        }
                    }
                })
                .on('broadcast', { event: 'typing' }, (payload) => {
                    const indicator = document.getElementById('typing-indicator');
                    if (payload.clientId === clientId) {
                        indicator.textContent = `${payload.name} est치 escribiendo...`;
                        setTimeout(() => {
                            indicator.textContent = '';
                        }, 2000);
                    }
                })
                .subscribe();
        }

        function closeChat() {
    console.log('游댗 Cerrando chat');
    
    activeChatClientId = null;
    activeClientAvatar = null;
    
    if (activeChannel) {
        _supabase.removeChannel(activeChannel);
        activeChannel = null;
    }
    
    // Cerrar animaci칩n
    const chatWindow = document.getElementById('chat-interface');
    chatWindow.classList.remove('active');
    
    // Esperar a que termine la animaci칩n antes de ocultar
    setTimeout(() => {
        chatWindow.style.display = 'none';
        
        // Asegurarnos que el dashboard est칠 visible (por si acaso)
        document.getElementById('dashboard').style.display = 'block';
        
        // Recargar lista de contactos
        loadChatsList();
        
        // Limpiar campo de entrada
        document.getElementById('msg-input').value = '';
        
        // Quitar indicador de escritura
        document.getElementById('typing-indicator').textContent = '';
    }, 300);
}

        async function sendMessage(e) {
            e.preventDefault(); 
            const input = document.getElementById('msg-input'); 
            const text = input.value.trim();
            if(!text || !activeChatClientId) return; 
            
            // Enviar mensaje
            renderMessage({ contenido: text, enviado_por_rol: 'due침o', created_at: new Date() });
            input.value = '';
            
            // Enfocar de nuevo el input
            input.focus();
            
            await _supabase.from('mensajes').insert({ 
                tienda_id: currentUser.id, 
                cliente_id: activeChatClientId, 
                enviado_por_rol: 'due침o', 
                contenido: text 
            });
        }
        
        function notifyTyping() { 
            if(activeChannel) activeChannel.send({ 
                type: 'broadcast', 
                event: 'typing', 
                payload: { 
                    clientId: activeChatClientId, 
                    name: document.getElementById('current-chat-name').textContent 
                } 
            }); 
        }

        function showClientInfo() {
            if (!activeChatClientId) return;
            
            const clientName = document.getElementById('current-chat-name').textContent;
            const clientAvatar = document.getElementById('chat-avatar-img').src;
            
            // Aqu칤 puedes implementar un modal con informaci칩n del cliente
            customConfirm(
                'Informaci칩n del Cliente',
                `<div style="text-align:center;">
                    <img src="${clientAvatar}" style="width:80px;height:80px;border-radius:50%;margin-bottom:15px;">
                    <h4 style="margin:10px 0;">${clientName}</h4>
                    <p style="color:#64748b;">Cliente ID: ${activeChatClientId}</p>
                </div>`,
                'info',
                () => {}
            );
        }

        // --- CROPPER Y CONFIG ---
        let cropper; const logoInput = document.getElementById('logo-input'); const cropModal = document.getElementById('crop-modal'); const imageTarget = document.getElementById('crop-image-target');
        logoInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (evt) => { imageTarget.src = evt.target.result; openCropModal(); }; reader.readAsDataURL(file); } });
        function openCropModal() { cropModal.style.display = 'flex'; if(cropper) cropper.destroy(); cropper = new Cropper(imageTarget, { aspectRatio: 4 / 1, viewMode: 2, autoCropArea: 1 }); }
        function cancelCrop() { cropModal.style.display = 'none'; logoInput.value = ''; if(cropper) cropper.destroy(); }
        async function confirmCrop() {
            if(!cropper) return;
            const canvas = cropper.getCroppedCanvas({ width: 600, height: 150 });
            canvas.toBlob(async (blob) => {
                const btnConfirm = document.querySelector('#crop-modal .btn-primary'); const txtOriginal = btnConfirm.innerHTML;
                btnConfirm.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo...'; btnConfirm.disabled = true;
                try {
                    const fileName = `logo_${currentUser.id}_${Date.now()}.png`;
                    const { error: uploadErr } = await _supabase.storage.from('tienda-logos').upload(fileName, blob, { contentType: 'image/png', upsert: true });
                    if (uploadErr) throw uploadErr;
                    const { data: urlData } = _supabase.storage.from('tienda-logos').getPublicUrl(fileName);
                    await _supabase.from('usuarios').update({ logo_url: urlData.publicUrl }).eq('id', currentUser.id);
                    showToast("춰Logo actualizado!", "Ya aparece en tu tienda."); 
                    updateAdminLogoUI(urlData.publicUrl); 
                    currentStoreLogo = urlData.publicUrl;
                    cancelCrop();
                } catch (error) { showToast("Error", error.message); } finally { btnConfirm.innerHTML = txtOriginal; btnConfirm.disabled = false; }
            }, 'image/png');
        }
        
        function updateAdminLogoUI(url) {
            const preview = document.getElementById('logo-img-preview'); const placeholder = document.getElementById('logo-placeholder');
            if(url) { preview.src = url; preview.style.display = 'block'; placeholder.style.display = 'none'; }
        }

        // --- PROCESAMIENTO DE IMAGEN PWA A BASE64 ---
        function processPwaIcon(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const maxSize = 512;

                    if (width > height) {
                        if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                    } else {
                        if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    
                    document.getElementById('pwa-preview').src = dataUrl;
                    document.getElementById('pwa-preview').style.display = 'block';
                    document.getElementById('conf-pwa-b64').value = dataUrl;
                    document.getElementById('pwa-text').textContent = "춰칈cono listo para guardar!";
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function loadConfig() {
            const { data } = await _supabase.from('usuarios').select('*').eq('id', currentUser.id).single();
            if (!data) return;
            
            document.getElementById('conf-nombre-admin').value = data.nombre || '';
            document.getElementById('conf-telefono').value = data.telefono || '';
            document.getElementById('conf-banco').value = data.banco_nombre || '';
            document.getElementById('conf-titular').value = data.banco_titular || '';
            document.getElementById('conf-ci').value = data.banco_ci || '';
            document.getElementById('conf-numero').value = data.banco_numero || '';
            if(data.banco_tipo) document.getElementById('conf-tipo').value = data.banco_tipo;
            if(data.logo_url) updateAdminLogoUI(data.logo_url);
            if(data.slug) document.getElementById('conf-alias').value = data.slug;
            if (data.qr_imagen_url) { document.getElementById('qr-preview').src = data.qr_imagen_url; document.getElementById('qr-preview').style.display = 'block'; }
            
            if(data.pwa_nombre_app) document.getElementById('conf-pwa-nombre').value = data.pwa_nombre_app;
            if(data.pwa_icono_b64) {
                document.getElementById('conf-pwa-b64').value = data.pwa_icono_b64;
                document.getElementById('pwa-preview').src = data.pwa_icono_b64;
                document.getElementById('pwa-preview').style.display = 'block';
            }
        }

        document.getElementById('config-form').addEventListener('submit', async (e) => {
            e.preventDefault(); const btn = document.getElementById('btn-save-config'); btn.textContent = "Guardando..."; btn.disabled = true;
            try {
                const file = document.getElementById('qr-input').files[0]; let qrUrl = document.getElementById('qr-preview').src; 
                if (file) {
                    const fileName = `qr_${currentUser.id}_${Date.now()}.${file.name.split('.').pop()}`;
                    await _supabase.storage.from('imagenes-pagos').upload(fileName, file, { upsert: true });
                    const { data } = _supabase.storage.from('imagenes-pagos').getPublicUrl(fileName); qrUrl = data.publicUrl;
                }

                const aliasInput = document.getElementById('conf-alias').value.trim().toLowerCase();
                
                const updates = {
                    nombre: document.getElementById('conf-nombre-admin').value,
                    telefono: document.getElementById('conf-telefono').value,
                    banco_nombre: document.getElementById('conf-banco').value,
                    banco_titular: document.getElementById('conf-titular').value,
                    banco_ci: document.getElementById('conf-ci').value,
                    banco_numero: document.getElementById('conf-numero').value,
                    banco_tipo: document.getElementById('conf-tipo').value,
                    slug: aliasInput || null, 
                    qr_imagen_url: qrUrl && qrUrl.startsWith('http') ? qrUrl : null,
                    pwa_nombre_app: document.getElementById('conf-pwa-nombre').value.trim(),
                    pwa_icono_b64: document.getElementById('conf-pwa-b64').value
                };
                
                const { error } = await _supabase.from('usuarios').update(updates).eq('id', currentUser.id);
                if (error) {
                    if (error.code === '23505') throw new Error("춰Ese nombre de tienda ya existe!");
                    throw error;
                }

                showToast("춰Configuraci칩n guardada!", "Datos actualizados.");
                if(aliasInput) { localStorage.setItem(`hasSharedLink_${currentUser.id}`, 'true'); checkOnboarding(); }

            } catch (err) { showToast("Error", err.message); } finally { btn.disabled = false; btn.textContent = "Guardar Configuraci칩n"; }
        });

        // PWA INSTALL LOGIC
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log("App lista para instalar");
        });

        async function installPWA() {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`El usuario decidi칩: ${outcome}`);
            deferredPrompt = null;
        }

        window.addEventListener('appinstalled', () => {
            console.log('App instalada exitosamente');
        });

        function updateCategoryDatalist() {
            const rawCategories = productsCache.map(p => p.categoria).filter(c => c && c.trim() !== '');
            const uniqueCategories = [...new Set(rawCategories)];
            const datalist = document.getElementById('lista-categorias');
            datalist.innerHTML = uniqueCategories.sort().map(cat => 
                `<option value="${cat}">`
            ).join('');
        }
    </script>
</body>
</html>
