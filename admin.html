<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <title>Admin Panel - Studio</title>

    <link rel="manifest" href="./manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Studio">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- ESTILOS GENERALES --- */
        :root { --primary: #1e293b; --accent: #6366f1; --bg: #f8fafc; --surface: #ffffff; --text: #334155; --border: #e2e8f0; --radius: 16px; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 15px; min-height: 100vh; padding-bottom: 80px; }
        .container { max-width: 960px; margin: 0 auto; }

        /* Login */
        #login-container { max-width: 100%; width: 400px; margin: 60px auto; background: var(--surface); padding: 30px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: var(--surface); padding: 15px 20px; border-radius: var(--radius); box-shadow: var(--shadow); flex-wrap: wrap; gap: 10px;}
        .store-code-badge { background: #eff6ff; color: var(--accent); padding: 5px 12px; border-radius: 8px; font-weight: 600; border: 1px dashed var(--accent); font-size: 0.9rem; cursor: pointer; transition: border-color 0.3s; border-width: 2px; }

        /* Tabs Navigation */
        .nav-tabs { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            overflow-x: auto; 
            padding: 10px; 
            margin-left: -10px; 
            margin-right: -10px;
            width: calc(100% + 20px);
        }
        .nav-tabs::-webkit-scrollbar { display: none; }
        .tab { padding: 10px 20px; border: none; background: white; color: #64748b; font-weight: 600; border-radius: 30px; font-size: 0.9rem; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.02); position: relative; transition: all 0.2s; }
        .tab.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(30, 41, 59, 0.3); transform: scale(1.05); }

        /* Badges */
        .badge-count { 
            position: absolute; top: -5px; right: -5px; 
            background-color: #ef4444; color: white; 
            font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; 
            font-weight: bold; display: none; animation: popIn 0.3s ease;
            z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 2px solid white; 
        }

        /* Toasts */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast-notification { background: white; border-left: 4px solid var(--accent); padding: 15px 20px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 15px; animation: slideInRight 0.3s ease-out forwards; min-width: 250px; }
        .toast-content div { font-weight: 600; font-size: 0.9rem; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* UI Components */
        .card { background: var(--surface); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        label { display: block; margin-bottom: 6px; font-size: 0.8rem; font-weight: 600; color: #64748b; text-transform: uppercase; }
        input, textarea, select { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 12px; background: #f8fafc; font-family: 'Inter', sans-serif; font-size: 16px; appearance: none; }
        .btn { padding: 14px 20px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; width: 100%; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); padding: 8px 16px; font-size: 0.9rem; width: auto; }
        .btn-icon { width: 36px; height: 36px; padding: 0; border-radius: 8px; display: inline-flex; margin-left: 5px; align-items: center; justify-content: center;}
        .btn-danger { background: #fee2e2; color: #dc2626; }
        .btn-edit { background: #e0e7ff; color: var(--accent); }
        .upload-zone { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 30px 20px; text-align: center; background: #f8fafc; margin-bottom: 20px; cursor: pointer; }
        .panel-section { display: none; animation: fadeIn 0.3s ease; }
        .panel-section.active { display: block; }

        /* --- NUEVO DISE칌O DE BANDEJA DE ENTRADA (LISTA) --- */
        #chats-list {
            display: flex;
            flex-direction: column;
            gap: 0; /* Sin espacio para que parezca lista continua */
        }

        .chat-list-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            background: white;
            transition: background 0.2s ease;
        }

        .chat-list-item:hover {
            background-color: #f8fafc;
        }

        .chat-list-item:active {
            background-color: #eff6ff;
        }

        .chat-avatar-container {
            position: relative;
            margin-right: 15px;
        }

        .chat-avatar-img {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #e2e8f0;
            background: #f1f5f9;
        }

        .chat-info {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .chat-name-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .chat-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 1rem;
        }

        .chat-time {
            font-size: 0.75rem;
            color: #94a3b8;
            font-weight: 500;
        }

        .chat-preview {
            font-size: 0.9rem;
            color: #64748b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Indicador de mensaje no le칤do */
        .chat-list-item.unread {
            background-color: #f0fdf4; /* Verde muy suave */
        }
        .chat-list-item.unread .chat-name {
            font-weight: 800;
            color: #000;
        }
        .chat-list-item.unread .chat-preview {
            color: #16a34a; /* Texto verde */
            font-weight: 600;
        }

        /* --- CHAT PANTALLA COMPLETA --- */
        .chat-window { 
            position: fixed; /* Fijo para cubrir todo */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #efe7dd; /* Color fondo tipo WA */
            z-index: 10000; /* Por encima de todo */
            display: flex;
            flex-direction: column;
            transform: translateX(100%); /* Oculto a la derecha por defecto */
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .chat-window.active { 
            transform: translateX(0); /* Deslizar para mostrar */
            display: flex; 
        }
        
        .chat-header { 
            padding: 12px 15px; 
            background: var(--primary); 
            color: white;
            display: flex; 
            align-items: center; 
            gap: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .chat-header-avatar { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 2px solid rgba(255,255,255,0.2); 
        }

        .chat-messages { 
            flex: 1; 
            padding: 20px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%239C92AC' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        }
        
        .msg-row { display: flex; align-items: flex-end; gap: 8px; max-width: 85%; }
        .msg-row.me { align-self: flex-end; flex-direction: row-reverse; }
        .msg-row.them { align-self: flex-start; }

        .msg-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; box-shadow: 0 1px 2px rgba(0,0,0,0.1); flex-shrink: 0; }
        
        .msg-bubble { 
            padding: 10px 14px; 
            border-radius: 12px; 
            font-size: 0.95rem; 
            position: relative; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.15); 
            line-height: 1.4; 
            word-wrap: break-word;
        }
        .msg-row.me .msg-bubble { background: #dcf8c6; color: #111; border-bottom-right-radius: 0; }
        .msg-row.them .msg-bubble { background: #ffffff; color: #111; border-bottom-left-radius: 0; }
        
        .msg-bubble img { 
            max-width: 100%; width: auto !important; height: auto !important;
            max-height: 250px !important; border-radius: 8px; margin-top: 5px;
            display: block; object-fit: contain;
        }
        
        .chat-input-area { padding: 10px; background: white; display: flex; gap: 10px; border-top: 1px solid var(--border); align-items: center; }
        .typing-indicator { font-size: 0.75rem; color: #64748b; margin-left: 55px; margin-top: -15px; margin-bottom: 5px; height: 15px; font-style: italic; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* ESTILOS PARA ONBOARDING (MANUAL DE USO) */
        .onboarding-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 25px;
            border-radius: var(--radius);
            margin-bottom: 25px;
            box-shadow: 0 10px 25px rgba(30, 41, 59, 0.3);
            position: relative;
            overflow: hidden;
            display: none; 
            transition: opacity 0.3s ease;
        }
        .onboarding-card::before {
            content: ''; position: absolute; top: -50px; right: -50px;
            width: 150px; height: 150px; background: rgba(255,255,255,0.05);
            border-radius: 50%;
        }
        .onboarding-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .onboarding-title { font-size: 1.2rem; font-weight: 700; margin: 0; }
        .onboarding-subtitle { opacity: 0.8; font-size: 0.9rem; margin-top: 5px; }
        
        .progress-container { margin: 15px 0; }
        .progress-bar-bg { height: 8px; background: rgba(255,255,255,0.2); border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: #22c55e; width: 0%; transition: width 0.5s ease; box-shadow: 0 0 10px rgba(34, 197, 94, 0.5); }
        .progress-text { font-size: 0.8rem; font-weight: 600; text-align: right; margin-top: 5px; color: #4ade80; }

        .steps-list { display: flex; flex-direction: column; gap: 10px; }
        .step-item { 
            background: rgba(255,255,255,0.1); padding: 12px 15px; border-radius: 12px; 
            display: flex; align-items: center; justify-content: space-between;
            transition: 0.2s; border: 1px solid rgba(255,255,255,0.05);
        }
        .close-onboarding {
            background: rgba(255,255,255,0.1); border: none; color: white; 
            cursor: pointer; font-size: 1.1rem; width: 32px; height: 32px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
        }
        .close-onboarding:hover { background: rgba(255,255,255,0.3); }

        /* Utilidades y Modales Custom */
        .custom-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px);
            z-index: 9999; display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .custom-modal-overlay.open { display: flex; opacity: 1; }
        .custom-modal-card { background: white; width: 90%; max-width: 400px; padding: 25px; border-radius: 24px; text-align: center; transform: scale(0.9); transition: transform 0.3s; }
        .custom-modal-overlay.open .custom-modal-card { transform: scale(1); }
        
        /* Cropper */
        #crop-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index: 5000; display:none; justify-content:center; align-items:center; flex-direction:column; padding: 20px; }
        .crop-container { max-width: 90%; max-height: 70vh; background: #333; overflow: hidden; border-radius: 8px; }
        .crop-container img { max-width: 100%; display: block; }

        /* Resumen */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); position: relative; overflow: hidden; }
        .stat-card .value { font-size: 2rem; font-weight: 700; color: var(--primary); }

        /* Tablas */
        .table-container { overflow-x: auto; margin: 0 -20px; padding: 0 20px; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        
        .gallery-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .gallery-item { position: relative; width: 100%; aspect-ratio: 1/1; border-radius: 8px; overflow: hidden; border: 1px solid #e2e8f0; }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

    <div id="login-container">
        <h2 id="auth-title" style="margin-bottom: 10px;">Admin Access</h2>
        <form id="auth-form">
            <input type="email" id="email" placeholder="Correo Electr칩nico" required>
            <input type="password" id="password" placeholder="Contrase침a" required>
            <button type="submit" id="btn-auth-action" class="btn btn-primary">Ingresar</button>
        </form>
        <p id="auth-msg" style="color: var(--accent); margin-top: 15px; min-height: 20px; font-size: 0.9rem;"></p>
        <div style="margin-top: 20px; border-top: 1px solid #e2e8f0; padding-top: 15px; font-size: 0.9rem; color: #64748b;">
            <span id="toggle-text">쯅o tienes cuenta?</span>
            <button type="button" id="btn-toggle-auth" onclick="toggleAuthMode()" style="background:none; border:none; color: var(--accent); font-weight:bold; cursor:pointer; font-size: 0.9rem; text-decoration: underline;">Crear Tienda</button>
        </div>
    </div>

    <div id="toast-container"></div>

    <div id="app-modal" class="custom-modal-overlay">
        <div class="custom-modal-card" id="modal-card-content">
            <div id="modal-icon" style="font-size:2rem; margin-bottom:15px;"><i class="fas fa-info-circle"></i></div>
            <h3 id="modal-title" style="margin-bottom:10px;">T칤tulo</h3>
            <p id="modal-msg" style="margin-bottom:20px; color:#64748b;">Descripci칩n aqu칤.</p>
            <div style="display:flex; gap:10px;">
                <button onclick="closeCustomModal()" class="btn" style="background:#f1f5f9; color:#64748b;">Cancelar</button>
                <button id="btn-modal-confirm" class="btn btn-primary">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="dashboard" class="container" style="display:none;">
        <div class="header">
            <div>
                <h2 style="margin:0; font-size:1.1rem; color: var(--primary);">Studio Panel</h2>
                <div style="display:flex; gap: 10px; margin-top: 5px; align-items: center;">
                    <div id="store-code-display" class="store-code-badge" onclick="copyCode()" title="Copiar c칩digo">...</div>
                    <button onclick="shareStoreLink()" class="btn-icon" style="background: var(--accent); color: white; width: auto; padding: 0 12px; font-size: 0.85rem; height: 32px;">
                        <i class="fas fa-share-alt"></i> <span style="margin-left:5px;">Link</span>
                    </button>
                </div>
            </div>
            <button onclick="logout()" class="btn btn-outline"><i class="fas fa-sign-out-alt"></i></button>
        </div>

        <div id="onboarding-card" class="onboarding-card">
            <div class="onboarding-header">
                <div>
                    <h3 class="onboarding-title">Bienvenido 游녦</h3>
                    <div class="onboarding-subtitle">Tu gu칤a r치pida para empezar.</div>
                </div>
                <button class="close-onboarding" onclick="hideOnboarding()" title="Cerrar Manual"><i class="fas fa-times"></i></button>
            </div>
            <div class="progress-container">
                <div class="progress-bar-bg"><div id="ob-progress-fill" class="progress-fill"></div></div>
                <div id="ob-progress-text" class="progress-text">0% Completado</div>
            </div>
            <div class="steps-list">
                <div id="step-1" class="step-item">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <i class="fas fa-box"></i> <span>Crear producto</span>
                    </div>
                    <button class="btn btn-primary" style="padding:5px 10px; font-size:0.8rem;" onclick="goToAddProduct()">Ir</button>
                </div>
                <div id="step-2" class="step-item">
                     <div style="display:flex; gap:10px; align-items:center;">
                        <i class="fas fa-share-alt"></i> <span>Compartir link</span>
                    </div>
                    <button class="btn btn-primary" style="padding:5px 10px; font-size:0.8rem;" onclick="shareStoreLink()">Ir</button>
                </div>
            </div>
        </div>

        <div class="nav-tabs">
            <button class="tab" onclick="switchTab('resumen')"><i class="fas fa-chart-pie"></i> Resumen</button>
            <button class="tab active" onclick="switchTab('productos')"><i class="fas fa-box"></i> Productos</button>
            <button class="tab" onclick="switchTab('chats')"><i class="fas fa-comments"></i> Chats <span id="badge-chats" class="badge-count">0</span></button>
            <button class="tab" onclick="switchTab('pedidos')"><i class="fas fa-bell"></i> Pedidos <span id="badge-orders" class="badge-count">0</span></button>
            <button class="tab" onclick="switchTab('config')"><i class="fas fa-cog"></i> Configuraci칩n</button>
        </div>

        <div id="tab-chats" class="panel-section">
            <div class="card" style="padding: 0; overflow: hidden; border-radius: 12px;">
                <div style="padding: 20px; border-bottom: 1px solid #f1f5f9; background: white;">
                    <h3 style="margin:0;">Mensajes</h3>
                </div>
                <div id="chats-list" style="background: white; min-height: 300px;">
                    <div style="padding:40px; text-align:center; color:#94a3b8;">
                        <i class="fas fa-spinner fa-spin"></i> Cargando...
                    </div>
                </div>
            </div>
            
            <div id="chat-interface" class="chat-window">
                <div class="chat-header">
                    <button class="btn btn-outline" style="padding: 5px; border:none; color:white; font-size: 1.2rem;" onclick="closeChat()">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div id="current-chat-avatar"></div>
                    <div>
                        <div style="font-weight:600; font-size:1.1rem;" id="current-chat-name">Cliente</div>
                        <div style="font-size:0.8rem; opacity:0.8;">En l칤nea</div>
                    </div>
                </div>
                
                <div class="chat-messages" id="messages-container"></div>
                
                <div class="typing-indicator" id="typing-indicator"></div>
                
                <form class="chat-input-area" onsubmit="sendMessage(event)">
                    <input type="text" id="msg-input" placeholder="Escribe un mensaje..." style="margin:0; border:none; background:#f1f5f9; padding:12px 15px; border-radius:20px;" autocomplete="off">
                    <button type="submit" class="btn btn-primary" style="width:45px; height:45px; border-radius:50%; padding:0;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>

        <div id="tab-resumen" class="panel-section">
            <div class="summary-grid">
                <div class="stat-card">
                    <h4>Ingresos</h4>
                    <div class="value" id="stat-income">$0.00</div>
                </div>
                <div class="stat-card">
                    <h4>Pedidos</h4>
                    <div class="value" id="stat-orders">0</div>
                </div>
            </div>
            <div class="card">
                <h3>칔ltimos Movimientos</h3>
                <div class="table-container">
                    <table id="recent-sales-table">
                        <thead><tr><th>Cliente</th><th>Monto</th><th>Fecha</th></tr></thead>
                        <tbody id="recent-sales-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-productos" class="panel-section active">
            <div class="card" id="form-card">
                <h3 id="form-title"><i class="fas fa-plus-circle"></i> Nuevo Producto</h3>
                <form id="product-form">
                    <div class="form-grid">
                        <input type="text" id="nombre" placeholder="Nombre" required>
                        <input type="number" step="0.01" id="precio" placeholder="Precio" required>
                    </div>
                    <textarea id="descripcion" rows="2" placeholder="Descripci칩n"></textarea>
                    
                    <div class="form-grid">
                        <input type="text" id="marca" placeholder="Marca (Ej: Nike)" style="background: white;">
                        <input type="number" id="stock" value="10" placeholder="Stock">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <input type="text" id="categoria" list="lista-categorias" placeholder="Categor칤a" style="width:100%;">
                        <datalist id="lista-categorias"></datalist>
                    </div>
                    
                    <label>Im치genes (M치x 6)</label>
                    <div class="upload-zone" onclick="document.getElementById('imagen-input').click()">
                        <p style="margin:0; color:#64748b;">Toca para seleccionar fotos</p>
                        <input type="file" id="imagen-input" accept="image/*" multiple style="display:none;">
                    </div>
                    <div id="gallery-preview-container" class="gallery-preview-grid"></div>

                    <div style="margin-bottom: 15px;"><input type="checkbox" id="destacado"> Destacar</div>
                    <button type="submit" id="btn-save" class="btn btn-primary">Publicar</button>
                    <button type="button" id="btn-cancel" class="btn" style="display:none; background:#eee;" onclick="resetForm()">Cancelar</button>
                </form>
            </div>
            <div class="card">
                <h3>Inventario</h3>
                <div class="table-container"><table id="products-table"></table></div>
            </div>
        </div>

        <div id="tab-pedidos" class="panel-section">
            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <h3>Pedidos</h3>
                    <button onclick="loadOrders()" class="btn btn-outline"><i class="fas fa-sync"></i></button>
                </div>
                <div id="orders-list"></div>
            </div>
        </div>

       <div id="tab-config" class="panel-section">
            <div class="card">
                <h3>Configuraci칩n App</h3>
                <input type="text" id="conf-pwa-nombre" placeholder="Nombre de la App">
                <div class="upload-zone" onclick="document.getElementById('pwa-icon-input').click()">
                    <p style="margin:0; color:#64748b;">Subir 칈cono App</p>
                    <img id="pwa-preview" style="display:none; width:60px; height:60px; margin:10px auto; border-radius:10px;">
                    <input type="file" id="pwa-icon-input" accept="image/*" style="display:none;" onchange="processPwaIcon(this)">
                </div>
                <input type="hidden" id="conf-pwa-b64">
            </div>

            <div class="card">
                <h3>Datos Generales</h3>
                <form id="config-form">
                    <input type="text" id="conf-nombre-admin" placeholder="Tu nombre">
                    <input type="tel" id="conf-telefono" placeholder="WhatsApp Soporte">
                    
                    <div style="margin-bottom: 20px; padding: 10px; background: #f0fdf4; border: 1px dashed #22c55e; border-radius: 8px;">
                        <label style="color: #15803d;">Alias (Link corto)</label>
                        <input type="text" id="conf-alias" placeholder="ej: mi-tienda" style="margin:0;" oninput="this.value = this.value.replace(/[^a-z0-9-]/g, '')">
                    </div>

                    <h4>Datos Bancarios</h4>
                    <input type="text" id="conf-banco" placeholder="Banco">
                    <div class="form-grid">
                        <input type="text" id="conf-titular" placeholder="Titular">
                        <input type="text" id="conf-ci" placeholder="C.I. / RIF">
                    </div>
                    <div class="form-grid">
                        <input type="text" id="conf-numero" placeholder="Cuenta / Tel칠fono">
                        <select id="conf-tipo">
                            <option value="Pago M칩vil">Pago M칩vil</option>
                            <option value="Cuenta">Cuenta Bancaria</option>
                        </select>
                    </div>
                    <label>QR Pago</label>
                    <div class="upload-zone" onclick="document.getElementById('qr-input').click()">
                        <img id="qr-preview" style="display:none; max-width:100px;">
                        <p>Subir QR</p>
                        <input type="file" id="qr-input" accept="image/*" style="display:none;">
                    </div>
                    <button type="submit" id="btn-save-config" class="btn btn-primary">Guardar</button>
                </form>
            </div>
            
            <div class="card">
                <h3>Logo Tienda</h3>
                <div class="upload-zone" onclick="document.getElementById('logo-input').click()">
                     <img id="logo-img-preview" style="display:none; max-width:150px; margin:0 auto;">
                     <p>Cambiar Logo</p>
                     <input type="file" id="logo-input" accept="image/*" style="display:none;">
                </div>
            </div>
        </div>
        
    <div id="crop-modal">
        <div class="crop-container"><img id="crop-image-target" src=""></div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="cancelCrop()" class="btn btn-danger">Cancelar</button>
            <button onclick="confirmCrop()" class="btn btn-primary">Guardar</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://cirrapytmbnjlhxunkaq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpcnJhcHl0bWJuamxoeHVua2FxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NzAyMDAsImV4cCI6MjA3ODU0NjIwMH0.OtJiLGj1EvhPICFaA9ruL02Z9kSQ2jT0t3Smqph81C4';
        const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentUser = null;
        let storeCode = null;
        let currentStoreLogo = null;
        let activeChatClientId = null;
        let activeClientAvatar = null; 
        let activeChannel = null;
        let productsCache = []; 
        let ordersCache = [];
        let editingId = null;
        let galleryFiles = [];
        let cropper;
        let modalCallback = null;

        // --- FUNCIONES INTERFAZ ---
        function switchTab(t) {
            document.querySelectorAll('.panel-section').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(t === 'chats') loadChatsList(); 
            if(t === 'pedidos') loadOrders(); 
            if(t === 'config') loadConfig(); 
            if(t === 'resumen') loadSummary();
        }

        // --- SOLUCI칍N AL MANUAL DE USO (ONBOARDING) ---
        function checkOnboarding() {
            if(!currentUser) return;
            // Si ya lo ocult칩, no mostrar
            if(localStorage.getItem(`hideOnboarding_${currentUser.id}`) === 'true') {
                document.getElementById('onboarding-card').style.display = 'none';
                return;
            }
            
            // L칩gica de progreso...
            const hasProducts = productsCache.length > 0;
            const pct = hasProducts ? 50 : 0; // Simplificado para ejemplo
            document.getElementById('ob-progress-fill').style.width = pct + '%';
            document.getElementById('ob-progress-text').textContent = pct + '% Completado';
            
            document.getElementById('onboarding-card').style.display = 'block';
        }

        // ESTA ES LA FUNCI칍N QUE ARREGLA EL BOT칍N X
        function hideOnboarding() {
            // Cierre forzado y directo sin confirmar
            const card = document.getElementById('onboarding-card');
            card.style.opacity = '0';
            setTimeout(() => {
                card.style.display = 'none';
                if(currentUser) localStorage.setItem(`hideOnboarding_${currentUser.id}`, 'true');
            }, 300);
        }

        function goToAddProduct() {
            switchTab('productos');
            document.getElementById('form-card').scrollIntoView({ behavior: 'smooth' });
        }

        // --- SISTEMA DE CHAT NUEVO ---
        async function loadChatsList() {
            const listContainer = document.getElementById('chats-list');
            listContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#94a3b8;"><i class="fas fa-spinner fa-spin"></i> Cargando chats...</div>';

            const { data } = await _supabase.from('mensajes')
                .select('*, clientes(id, nombre, foto_b64)')
                .eq('tienda_id', currentUser.id)
                .order('created_at', { ascending: false });

            const grouped = {};
            if(data) {
                data.forEach(msg => { 
                    if (msg.clientes && !grouped[msg.cliente_id]) { 
                        grouped[msg.cliente_id] = { client: msg.clientes, lastMsg: msg }; 
                    } 
                });
            }

            const chatsHTML = Object.values(grouped).map(item => {
                const isUnread = !item.lastMsg.leido && item.lastMsg.enviado_por_rol === 'cliente';
                const avatarSrc = item.client.foto_b64 || `https://ui-avatars.com/api/?name=${encodeURIComponent(item.client.nombre)}&background=random`;
                const dateObj = new Date(item.lastMsg.created_at);
                const time = dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const isMe = item.lastMsg.enviado_por_rol === 'due침o';

                return `
                <div class="chat-list-item ${isUnread ? 'unread' : ''}" onclick="openChat('${item.client.id}', '${item.client.nombre}', '${avatarSrc}')">
                    <div class="chat-avatar-container">
                        <img src="${avatarSrc}" class="chat-avatar-img">
                    </div>
                    <div class="chat-info">
                        <div class="chat-name-row">
                            <span class="chat-name">${item.client.nombre}</span>
                            <span class="chat-time">${time}</span>
                        </div>
                        <div class="chat-preview">
                            ${isMe ? '<i class="fas fa-check" style="font-size:0.7rem;"></i> ' : ''}
                            ${item.lastMsg.contenido.substring(0, 35)}...
                        </div>
                    </div>
                </div>`;
            }).join('');

            listContainer.innerHTML = chatsHTML || '<div style="padding:40px; text-align:center; color:#94a3b8;">No tienes mensajes a칰n.</div>';
        }

        async function openChat(clientId, clientName, clientAvatarSrc) {
            activeChatClientId = clientId;
            activeClientAvatar = clientAvatarSrc;
            
            // L칩gica para abrir pantalla completa
            const chatInterface = document.getElementById('chat-interface');
            chatInterface.classList.add('active'); // Activa la animaci칩n CSS
            
            document.getElementById('current-chat-name').textContent = clientName; 
            document.getElementById('current-chat-avatar').innerHTML = `<img src="${activeClientAvatar}" class="chat-header-avatar">`;
            document.getElementById('messages-container').innerHTML = '';
            
            // Cargar mensajes
            const { data } = await _supabase.from('mensajes').select('*')
                .eq('tienda_id', currentUser.id).eq('cliente_id', clientId).order('created_at', { ascending: true });
            
            if(data) data.forEach(renderMessage);
            
            // Marcar le칤dos
            await _supabase.from('mensajes').update({ leido: true }).eq('cliente_id', clientId).eq('enviado_por_rol', 'cliente');
            
            // Suscribirse al typing
            if (activeChannel) await _supabase.removeChannel(activeChannel);
            activeChannel = _supabase.channel(`typing_${currentUser.id}_${clientId}`).subscribe();
        }

        function closeChat() {
            activeChatClientId = null;
            // Quitar clase active para que se deslice fuera
            document.getElementById('chat-interface').classList.remove('active');
            // Recargar la lista por si hubo mensajes nuevos
            setTimeout(loadChatsList, 300);
        }

        function renderMessage(msg) {
            const isMe = msg.enviado_por_rol === 'due침o';
            const divRow = document.createElement('div');
            divRow.className = `msg-row ${isMe ? 'me' : 'them'}`;
            const avatarUrl = isMe ? (currentStoreLogo || 'https://via.placeholder.com/30') : (activeClientAvatar || 'https://via.placeholder.com/30');
            
            divRow.innerHTML = `
                <img src="${avatarUrl}" class="msg-avatar">
                <div class="msg-bubble">${msg.contenido}</div>
            `;
            const c = document.getElementById('messages-container'); 
            c.appendChild(divRow); c.scrollTop = c.scrollHeight;
        }

        async function sendMessage(e) {
            e.preventDefault(); const input = document.getElementById('msg-input'); const text = input.value.trim();
            if(!text || !activeChatClientId) return; input.value = '';
            renderMessage({ contenido: text, enviado_por_rol: 'due침o' });
            await _supabase.from('mensajes').insert({ tienda_id: currentUser.id, cliente_id: activeChatClientId, enviado_por_rol: 'due침o', contenido: text });
        }

        // --- AUTH & INIT ---
        _supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                currentUser = session.user;
                initAdmin(session.user);
            } else {
                document.getElementById('login-container').style.display = 'block';
                document.getElementById('dashboard').style.display = 'none';
            }
        });

        async function initAdmin(user) {
            let { data } = await _supabase.from('usuarios').select('*').eq('id', user.id).single();
            if (!data) {
                data = { id: user.id, email: user.email, codigo_tienda: 'TIENDA-' + Math.random().toString(36).substr(2,5).toUpperCase() };
                await _supabase.from('usuarios').insert(data);
            }
            storeCode = data.codigo_tienda;
            currentStoreLogo = data.logo_url;
            document.getElementById('store-code-display').textContent = storeCode;
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            await loadProducts();
            await loadOrders();
            checkOnboarding();
        }

        // --- MANEJO DE LOGIN ---
        let isLoginMode = true;
        function toggleAuthMode() { isLoginMode = !isLoginMode; document.getElementById('auth-title').textContent = isLoginMode ? 'Admin Access' : 'Crear Tienda'; document.getElementById('btn-auth-action').textContent = isLoginMode ? 'Ingresar' : 'Registrar'; }
        
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('btn-auth-action');
            btn.textContent = 'Procesando...'; btn.disabled = true;
            
            try {
                const { error } = isLoginMode ? 
                    await _supabase.auth.signInWithPassword({ email, password }) : 
                    await _supabase.auth.signUp({ email, password });
                if(error) throw error;
                if(!isLoginMode) alert("Revisa tu correo para confirmar.");
            } catch(e) {
                document.getElementById('auth-msg').textContent = e.message;
                btn.disabled = false; btn.textContent = isLoginMode ? 'Ingresar' : 'Registrar';
            }
        });

        function logout() { _supabase.auth.signOut(); window.location.reload(); }

        // --- PRODUCTOS ---
        async function loadProducts() {
            const { data } = await _supabase.from('productos').select('*').eq('creado_por', currentUser.id).order('id', {ascending:false});
            productsCache = data || [];
            const table = document.getElementById('products-table');
            table.innerHTML = `<thead><tr><th>IMG</th><th>INFO</th><th>ACCION</th></tr></thead><tbody>${productsCache.map(p => `
                <tr>
                    <td><img src="${p.imagen_url || ''}" style="width:40px; height:40px; border-radius:5px; background:#eee;"></td>
                    <td><b>${p.nombre}</b><br><span style="color:#888">$${p.precio}</span></td>
                    <td><button class="btn-icon btn-danger" onclick="deleteProduct(${p.id})"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('')}</tbody>`;
            updateCategoryDatalist();
        }

        document.getElementById('imagen-input').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(f => galleryFiles.push({ type: 'file', data: f }));
            renderGallery();
        });

        function renderGallery() {
            const c = document.getElementById('gallery-preview-container'); c.innerHTML='';
            galleryFiles.forEach((item, i) => {
                const img = document.createElement('img'); img.src = item.type==='file' ? URL.createObjectURL(item.data) : item.data;
                const div = document.createElement('div'); div.className='gallery-item'; div.appendChild(img);
                div.onclick = () => { galleryFiles.splice(i,1); renderGallery(); };
                c.appendChild(div);
            });
        }

        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save'); btn.textContent = 'Guardando...'; btn.disabled = true;
            try {
                const uploaded = [];
                for(const f of galleryFiles) {
                    if(f.type === 'file') {
                        const name = `${currentUser.id}/${Date.now()}_${Math.random()}`;
                        await _supabase.storage.from('imagenes-productos').upload(name, f.data);
                        const { data } = _supabase.storage.from('imagenes-productos').getPublicUrl(name);
                        uploaded.push(data.publicUrl);
                    } else uploaded.push(f.data);
                }
                
                const prod = {
                    nombre: document.getElementById('nombre').value,
                    precio: document.getElementById('precio').value,
                    descripcion: document.getElementById('descripcion').value,
                    marca: document.getElementById('marca').value,
                    stock: document.getElementById('stock').value,
                    categoria: document.getElementById('categoria').value,
                    destacado: document.getElementById('destacado').checked,
                    creado_por: currentUser.id,
                    imagen_url: uploaded[0],
                    galeria: uploaded
                };
                
                await _supabase.from('productos').insert(prod);
                resetForm(); loadProducts(); alert("Producto creado");
            } catch(e) { alert(e.message); }
            btn.disabled = false; btn.textContent = 'Publicar';
        });

        function resetForm() { document.getElementById('product-form').reset(); galleryFiles=[]; renderGallery(); }
        async function deleteProduct(id) { if(confirm("쮹orrar?")) { await _supabase.from('productos').delete().eq('id', id); loadProducts(); } }
        
        function updateCategoryDatalist() {
            const unique = [...new Set(productsCache.map(p=>p.categoria))];
            document.getElementById('lista-categorias').innerHTML = unique.map(c=>`<option value="${c}">`).join('');
        }

        // --- PEDIDOS & RESUMEN ---
        async function loadOrders() {
            const { data } = await _supabase.from('pedidos').select('*, clientes(nombre)').eq('tienda_id', currentUser.id).order('fecha', {ascending:false});
            ordersCache = data || [];
            document.getElementById('orders-list').innerHTML = ordersCache.map(o => `
                <div style="border:1px solid #eee; padding:15px; margin-bottom:10px; border-radius:10px; border-left:4px solid ${o.estado==='pendiente'?'orange':'green'};">
                    <div style="font-weight:bold;">${o.clientes?.nombre || 'Cliente'} - $${o.total}</div>
                    <small>${new Date(o.fecha).toLocaleDateString()}</small>
                    ${o.estado === 'pendiente' ? `<button class="btn btn-primary" style="margin-top:10px; width:100%;" onclick="completeOrder(${o.id})">Despachar</button>` : ''}
                </div>
            `).join('');
        }
        
        async function completeOrder(id) {
            await _supabase.from('pedidos').update({ estado: 'completado' }).eq('id', id);
            loadOrders(); loadSummary();
        }

        async function loadSummary() {
            const { data } = await _supabase.from('pedidos').select('*').eq('tienda_id', currentUser.id).eq('estado', 'completado');
            const total = data.reduce((sum, o) => sum + parseFloat(o.total), 0);
            document.getElementById('stat-income').textContent = `$${total.toFixed(2)}`;
            document.getElementById('stat-orders').textContent = data.length;
        }

        // --- CONFIG & UTILS ---
        function copyCode() { navigator.clipboard.writeText(storeCode); alert("C칩digo copiado: "+storeCode); }
        async function shareStoreLink() {
            const url = `${window.location.origin}/tienda/${storeCode}`;
            if(navigator.share) await navigator.share({title: 'Mi Tienda', url: url});
            else { navigator.clipboard.writeText(url); alert("Link copiado: "+url); }
        }

        // PROCESAR ICONO PWA
        function processPwaIcon(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('pwa-preview').src = e.target.result;
                document.getElementById('pwa-preview').style.display='block';
                document.getElementById('conf-pwa-b64').value = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // --- LOGO CROPPER ---
        const logoIn = document.getElementById('logo-input');
        const imgTarget = document.getElementById('crop-image-target');
        logoIn.addEventListener('change', (e)=>{
            if(e.target.files[0]) {
                const r = new FileReader();
                r.onload = (evt) => {
                    imgTarget.src = evt.target.result;
                    document.getElementById('crop-modal').style.display='flex';
                    if(cropper) cropper.destroy();
                    cropper = new Cropper(imgTarget, { aspectRatio: 4/1, viewMode:2 });
                };
                r.readAsDataURL(e.target.files[0]);
            }
        });
        function cancelCrop() { document.getElementById('crop-modal').style.display='none'; logoIn.value=''; }
        function confirmCrop() {
            cropper.getCroppedCanvas({width:400}).toBlob(async (blob) => {
                const name = `logo_${currentUser.id}_${Date.now()}`;
                await _supabase.storage.from('tienda-logos').upload(name, blob);
                const {data} = _supabase.storage.from('tienda-logos').getPublicUrl(name);
                await _supabase.from('usuarios').update({logo_url: data.publicUrl}).eq('id', currentUser.id);
                document.getElementById('logo-img-preview').src = data.publicUrl;
                document.getElementById('logo-img-preview').style.display='block';
                cancelCrop();
            });
        }

        async function loadConfig() {
            const { data } = await _supabase.from('usuarios').select('*').eq('id', currentUser.id).single();
            if(data) {
                document.getElementById('conf-nombre-admin').value = data.nombre||'';
                document.getElementById('conf-telefono').value = data.telefono||'';
                document.getElementById('conf-alias').value = data.slug||'';
                document.getElementById('conf-banco').value = data.banco_nombre||'';
                document.getElementById('conf-titular').value = data.banco_titular||'';
                document.getElementById('conf-ci').value = data.banco_ci||'';
                document.getElementById('conf-numero').value = data.banco_numero||'';
                document.getElementById('conf-pwa-nombre').value = data.pwa_nombre_app||'';
                if(data.logo_url) { document.getElementById('logo-img-preview').src=data.logo_url; document.getElementById('logo-img-preview').style.display='block'; }
            }
        }

        document.getElementById('config-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const updates = {
                nombre: document.getElementById('conf-nombre-admin').value,
                telefono: document.getElementById('conf-telefono').value,
                slug: document.getElementById('conf-alias').value,
                banco_nombre: document.getElementById('conf-banco').value,
                banco_titular: document.getElementById('conf-titular').value,
                banco_ci: document.getElementById('conf-ci').value,
                banco_numero: document.getElementById('conf-numero').value,
                banco_tipo: document.getElementById('conf-tipo').value
            };
            await _supabase.from('usuarios').update(updates).eq('id', currentUser.id);
            alert("Guardado");
        });
    </script>
</body>
</html>
