<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <title>Admin Studio</title>

    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Studio">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- ESTILOS GENERALES --- */
        :root { 
            --bg: #f8f9fa; 
            --text-main: #1a1a1a; 
            --accent: #2563eb; 
            --radius: 12px;
            --btn-green: #10b981;
            --btn-red: #ef4444;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-main); }

        /* Login */
        #login-form-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 500; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { width: 100%; max-width: 350px; text-align: center; background: white; padding: 30px; border-radius: var(--radius); box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 0.9rem; font-weight: 600; margin-bottom: 5px; color: #475569; }
        .login-input { width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 1rem; background: #f9fafb; transition: border-color 0.2s; }
        .login-input:focus { outline: none; border-color: var(--accent); background: white; }
        .btn-action { width: 100%; padding: 15px; background: var(--text-main); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: background 0.2s; font-size: 1rem; margin-top: 10px; }
        .btn-action:hover { background: #333; }
        
        /* Layout Principal */
        #app-container { display: none; }
        .header { background: white; position: sticky; top: 0; z-index: 100; padding: 1rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .header h1 { font-size: 1.5rem; font-weight: 700; color: var(--text-main); }
        .content { padding: 20px; max-width: 1200px; margin: 0 auto; }
        
        /* Navegación por pestañas */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { padding: 10px 20px; border: none; background: white; color: #64748b; font-weight: 600; border-radius: 8px; cursor: pointer; transition: all 0.2s; border: 1px solid #e2e8f0; white-space: nowrap;}
        .tab-btn.active { background: var(--text-main); color: var(--accent); border-color: var(--text-main); transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .panel-section { display: none; }
        
        /* Tarjetas de Contenido */
        .card { background: white; padding: 20px; border-radius: var(--radius); box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #f1f1f1; }
        .card h3 { font-size: 1.1rem; margin-bottom: 15px; font-weight: 700; display: flex; align-items: center; gap: 8px; color: var(--text-main); }

        /* Productos */
        #products-list { margin-top: 20px; }
        .product-item { display: flex; gap: 15px; padding: 15px; border-bottom: 1px solid #eee; align-items: center; transition: background 0.2s; cursor: pointer; }
        .product-item:last-child { border-bottom: none; }
        .product-item:hover { background: #fcfcfc; }
        .product-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; flex-shrink: 0; }
        .product-info { flex-grow: 1; }
        .product-info div { font-weight: 600; }
        .product-info small { color: #64748b; font-size: 0.8rem; }
        .product-actions button { background: none; border: none; color: var(--text-main); margin-left: 10px; cursor: pointer; font-size: 1rem; opacity: 0.7; transition: opacity 0.2s; }
        .product-actions button:hover { opacity: 1; color: var(--accent); }
        
        /* Modal de Producto */
        #product-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 400; display: none; align-items: center; justify-content: center; padding: 20px; }
        #product-modal.open { display: flex; }
        .modal-content { background: white; padding: 25px; border-radius: var(--radius); width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; position: relative; }
        .close-modal { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #94a3b8; }
        .modal-content label { margin-top: 10px; }
        .btn-modal-save { background: var(--btn-green); color: white; margin-top: 20px; }
        .btn-modal-delete { background: var(--btn-red); color: white; margin-top: 10px; }
        
        /* Cropper */
        .image-cropper-container { max-height: 300px; overflow: hidden; margin-top: 10px; margin-bottom: 10px; border: 1px solid #eee; }
        .gallery-thumbs-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; padding: 10px; border: 1px dashed #e2e8f0; border-radius: 8px; }
        .gallery-thumb { position: relative; width: 80px; height: 80px; }
        .gallery-thumb img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; border: 1px solid #eee; }
        .gallery-thumb button { position: absolute; top: -5px; right: -5px; background: var(--btn-red); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        /* Logo Preview */
        .logo-preview-container { 
            height: 120px; 
            border: 2px dashed #e2e8f0; 
            border-radius: var(--radius); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            margin-bottom: 15px;
            overflow: hidden;
            transition: border-color 0.2s;
        }
        .logo-preview-container:hover { border-color: var(--accent); }
        .logo-preview-container img { max-width: 80%; max-height: 80%; object-fit: contain; }
        
        /* Configuración */
        .config-group { margin-bottom: 25px; border-top: 1px solid #eee; padding-top: 15px; }
        .config-group h4 { font-size: 1rem; margin-bottom: 10px; color: var(--accent); display: flex; align-items: center; gap: 5px; }
        .config-group input, .config-group select { margin-bottom: 15px; }
        
        /* QR Preview */
        #qr-preview { max-width: 150px; height: auto; display: none; margin-top: 10px; border: 1px solid #eee; border-radius: 8px; }
        
        /* Pedidos */
        .order-item { background: #fafafa; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid var(--accent); }
        .order-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; }
        .order-details { font-size: 0.9rem; color: #475569; margin-top: 8px; }
        .order-status { padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 0.8rem; }
        .status-pendiente { background: #fffbeb; color: #b45309; }
        .status-confirmado { background: #ecfdf5; color: #047857; }
        .status-enviado { background: #eff6ff; color: #1d4ed8; }
        .status-cancelado { background: #fee2e2; color: #dc2626; }

        /* Chat */
        #chat-clients-list { margin-top: 15px; }
        .client-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
        .client-item:hover { background: #f9fafb; }
        .client-item.active { background: #eff6ff; border-left: 4px solid var(--accent); }
        .client-info { flex-grow: 1; margin-left: 10px; }
        .client-info div { font-weight: 600; }
        .client-info small { color: #64748b; font-size: 0.8rem; }
        .unread-indicator { background: var(--btn-red); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; }

        #chat-panel { margin-top: 20px; display: flex; height: 70vh; min-height: 400px; border: 1px solid #e2e8f0; border-radius: var(--radius); overflow: hidden; }
        #chat-list-container { width: 300px; border-right: 1px solid #e2e8f0; overflow-y: auto; background: white; flex-shrink: 0; }
        #chat-window-container { flex-grow: 1; display: flex; flex-direction: column; background: #fcfcfc; }
        #chat-header-current { padding: 15px; background: white; border-bottom: 1px solid #eee; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        #chat-messages { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; word-wrap: break-word; }
        .msg.me { background: var(--text-main); color: white; align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg.client { background: #e0f2fe; color: var(--text-main); align-self: flex-end; border-bottom-right-radius: 2px; }
        #chat-input-form { padding: 10px; border-top: 1px solid #eee; display: flex; gap: 10px; background: white; }
        #chat-input-form input { flex-grow: 1; margin: 0; }
    </style>
</head>
<body>

    <div id="login-form-container">
        <div class="login-card">
            <h2 style="margin-bottom: 20px; color: var(--accent);">Admin Studio</h2>
            <form id="login-form">
                <div class="input-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" class="login-input" required>
                </div>
                <div class="input-group">
                    <label for="password">Contraseña:</label>
                    <input type="password" id="password" class="login-input" required>
                </div>
                <button type="submit" class="btn-action">Iniciar Sesión</button>
                <p id="login-error" style="color: var(--btn-red); margin-top: 10px; font-size: 0.9rem;"></p>
            </form>
        </div>
    </div>

    <div id="app-container">
        <div class="header">
            <h1 id="store-title">Admin Panel</h1>
            <div style="display:flex; gap:10px; align-items:center;">
                <span id="welcome-message" style="font-size:0.9rem; color:#64748b;"></span>
                <button class="btn-action" style="width:auto; padding:8px 15px; margin-top:0; background:var(--btn-red);" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <div class="content">
            <div class="tabs">
                <button class="tab-btn active" data-tab="tab-productos"><i class="fas fa-box"></i> Productos</button>
                <button class="tab-btn" data-tab="tab-pedidos"><i class="fas fa-receipt"></i> Pedidos</button>
                <button class="tab-btn" data-tab="tab-chat"><i class="fas fa-comments"></i> Chat</button>
                <button class="tab-btn" data-tab="tab-config"><i class="fas fa-cog"></i> Configuración</button>
            </div>

            <div id="tab-productos" class="panel-section" style="display: block;">
                <div class="card">
                    <h3><i class="fas fa-list"></i> Mi Colección</h3>
                    <button class="btn-action" style="width:auto; padding:10px 20px;" onclick="openProductModal()"><i class="fas fa-plus"></i> Nuevo Producto</button>
                    <div id="products-list"></div>
                </div>
            </div>

            <div id="tab-pedidos" class="panel-section">
                <div class="card">
                    <h3><i class="fas fa-receipt"></i> Órdenes Recibidas</h3>
                    <select id="order-filter" class="login-input" style="width:200px; margin-bottom:15px;" onchange="loadOrders()">
                        <option value="pendiente">Pendientes</option>
                        <option value="confirmado">Confirmados</option>
                        <option value="enviado">Enviados</option>
                        <option value="todos">Todos</option>
                    </select>
                    <div id="orders-list"></div>
                </div>
            </div>

            <div id="tab-chat" class="panel-section">
                <div class="card">
                    <h3><i class="fas fa-comments"></i> Chat con Clientes</h3>
                    <div id="chat-panel">
                        <div id="chat-list-container">
                            <div id="chat-clients-list"></div>
                        </div>
                        <div id="chat-window-container">
                            <div id="chat-header-current">
                                Selecciona un cliente para comenzar a chatear.
                            </div>
                            <div id="chat-messages">
                                </div>
                            <form id="chat-input-form">
                                <input type="text" id="chat-message-input" class="login-input" placeholder="Escribe un mensaje..." required disabled>
                                <button type="submit" class="btn-action" style="width:auto; padding:10px 15px; margin-top:0;" disabled>
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-config" class="panel-section">
                <form id="config-form" onsubmit="saveConfig(event)">
                    <div class="card">
                        <h3><i class="fas fa-image"></i> Identidad Visual</h3>
                        
                        <label>Nombre de la Tienda</label>
                        <input type="text" id="conf-nombre-tienda" class="login-input" placeholder="Ej: La Joyería de María" required>
                        <label>Enlace Personalizado (Alias)</label>
                        <input type="text" id="conf-alias" class="login-input" placeholder="Ej: joyeria-maria" pattern="[a-zA-Z0-9-]+" title="Solo letras, números y guiones">
                        <small style="color:#64748b; display:block; margin-bottom:15px;">URL de tu tienda: `[TU-DOMINIO]/?tienda=<span id="alias-display">alias</span>`</small>

                        <p style="font-size:0.85rem; color:#64748b; margin-bottom:15px;">Sube tu logo. Se recortará automáticamente.</p>
                        <div class="logo-preview-container" onclick="document.getElementById('logo-input').click()">
                            <img id="logo-preview" src="https://via.placeholder.com/150?text=Subir+Logo" alt="Logo Preview" style="display:none;">
                            <div id="logo-placeholder" style="color:#64748b;"><i class="fas fa-upload"></i> Clic para subir logo</div>
                        </div>
                        <input type="file" id="logo-input" accept="image/*" style="display: none;">
                        <button type="button" class="btn-action" style="width:auto; padding:10px 20px; margin-top:0; background:#f59e0b;" onclick="document.getElementById('logo-input').click()">Cambiar Logo</button>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-credit-card"></i> Datos de Pago (Transferencia / QR)</h3>
                        
                        <div class="config-group">
                            <label>Nombre del Banco</label>
                            <input type="text" id="conf-banco" class="login-input" placeholder="Ej: Banco Mercantil">
                            
                            <label>Titular de la Cuenta</label>
                            <input type="text" id="conf-titular" class="login-input" placeholder="Ej: Maria Lopez">
                            
                            <label>C.I. / RIF</label>
                            <input type="text" id="conf-ci" class="login-input" placeholder="Ej: V-12345678">
                            
                            <label>Número de Cuenta o Teléfono (Pago Móvil)</label>
                            <input type="text" id="conf-numero" class="login-input" placeholder="Ej: 0414-1234567" required>

                            <label>Tipo de Cuenta</label>
                            <select id="conf-tipo" class="login-input">
                                <option value="corriente">Corriente</option>
                                <option value="ahorro">Ahorro</option>
                                <option value="pago_movil">Pago Móvil</option>
                            </select>
                        </div>
                        
                        <div class="config-group">
                            <h4><i class="fas fa-qrcode"></i> Imagen de Código QR (Opcional)</h4>
                            <p style="font-size:0.85rem; color:#64748b; margin-bottom:15px;">Sube una imagen de tu código QR para facilitar el pago.</p>
                            <input type="file" id="qr-input" accept="image/*" style="display: none;">
                            <img id="qr-preview" alt="QR Preview">
                            <button type="button" class="btn-action" style="width:auto; padding:10px 20px; margin-top:0; background:#0ea5e9;" onclick="document.getElementById('qr-input').click()">Subir/Cambiar QR</button>
                        </div>
                    </div>
                    
                    <button type="submit" id="btn-save-config" class="btn-action btn-modal-save">Guardar Configuración</button>
                </form>
            </div>
            
        </div>
    </div>
    
    <div id="product-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeProductModal()"><i class="fas fa-times"></i></button>
            <h2 id="modal-title" style="margin-bottom: 20px; font-size: 1.5rem;">Nuevo Producto</h2>
            
            <form id="product-form" onsubmit="saveProduct(event)">
                <input type="hidden" id="product-id">
                
                <label>Nombre del Producto</label>
                <input type="text" id="prod-nombre" class="login-input" required>
                
                <label>Descripción</label>
                <textarea id="prod-descripcion" class="login-input" rows="3"></textarea>
                
                <label>Precio ($)</label>
                <input type="number" id="prod-precio" class="login-input" step="0.01" min="0" required>

                <label>Categoría</label>
                <input type="text" id="prod-categoria" class="login-input" list="lista-categorias" placeholder="Ej: Anillos, Cadenas, Aretes">
                <datalist id="lista-categorias"></datalist>

                <label>Stock (Unidades)</label>
                <input type="number" id="prod-stock" class="login-input" min="0" value="100">

                <label style="margin-top:15px;">Imagen Principal</label>
                <p style="font-size:0.85rem; color:#64748b; margin-bottom:10px;">La primera imagen que verán los clientes. Se recomienda una imagen cuadrada.</p>
                
                <input type="file" id="image-input" accept="image/*" style="display: none;">
                <div class="image-cropper-container">
                    <img id="image-to-crop" style="max-width: 100%; display: none;">
                </div>
                <button type="button" class="btn-action" style="width:auto; padding:10px 20px; margin-top:0; background:#f59e0b;" onclick="document.getElementById('image-input').click()">Subir Imagen</button>
                <button type="button" id="btn-crop-image" class="btn-action" style="width:auto; padding:10px 20px; margin-top:10px; background:#0ea5e9; display:none;">Recortar y Aplicar</button>
                
                <label style="margin-top:20px; display:block;">Galería de Imágenes (Opcional)</label>
                <input type="file" id="gallery-input" accept="image/*" style="display: none;" multiple onchange="uploadGalleryImages(this.files)">
                <div id="gallery-thumbs" class="gallery-thumbs-container">
                    <div style="color:#94a3b8; font-size:0.9rem;">No hay imágenes.</div>
                </div>
                <button type="button" class="btn-action" style="width:auto; padding:10px 20px; margin-top:15px; background:var(--accent);" onclick="document.getElementById('gallery-input').click()">Añadir a Galería</button>

                <button type="submit" id="btn-modal-save" class="btn-action btn-modal-save">Crear Producto</button>
                <button type="button" id="btn-modal-delete" class="btn-action btn-modal-delete" onclick="deleteProduct()" style="display:none;">Eliminar Producto</button>
            </form>
        </div>
    </div>


    <script>
        const SUPABASE_URL = 'https://cirrapytmbnjlhxunkaq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpcnJhcHl0bWJuamxoeHVua2FxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5NzAyMDAsImV4cCI6MjA3ODU0NjIwMH0.OtJiLGj1EvhPICFaA9ruL02Z9kSQ2jT0t3Smqph81C4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let productsCache = [];
        let cropper = null;
        let mainImageUrl = ''; // URL de la imagen principal, ya subida
        let galleryUrls = []; // Array de URLs de la galería
        let currentChatClient = null;
        let chatChannel = null;

        // --- AUTENTICACIÓN ---
        window.addEventListener('DOMContentLoaded', checkSession);

        async function checkSession() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                currentUser = user;
                document.getElementById('login-form-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                await initAdmin();
            } else {
                document.getElementById('login-form-container').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.querySelector('#login-form button');
            const errorP = document.getElementById('login-error');
            
            btn.disabled = true; errorP.textContent = "";

            try {
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                await checkSession();
            } catch (error) {
                errorP.textContent = error.message;
            } finally {
                btn.disabled = false;
            }
        });

        async function logout() {
            await supabase.auth.signOut();
            location.reload();
        }

        async function initAdmin() {
            const { data } = await supabase.from('usuarios').select('email, nombre_tienda, logo_url, slug').eq('id', currentUser.id).single();
            if(data) {
                document.getElementById('welcome-message').textContent = `Hola, ${data.email}`;
                // Usar el nombre de la tienda para el título
                document.getElementById('store-title').textContent = data.nombre_tienda || 'Admin Panel';
                document.getElementById('alias-display').textContent = data.slug || '[Aún no definido]';
            }
            
            loadProducts();
            loadOrders();
            loadClients();
            loadConfig();
            initTabs();
        }

        // --- NAVEGACIÓN DE PESTAÑAS ---
        function initTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.getAttribute('data-tab');
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.panel-section').forEach(p => p.style.display = 'none');
                    btn.classList.add('active');
                    document.getElementById(tab).style.display = 'block';
                    
                    if (tab === 'tab-pedidos') loadOrders();
                });
            });
        }

        // --- PRODUCTOS ---
        
        // Manejador del Cropper
        document.getElementById('image-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            const image = document.getElementById('image-to-crop');
            const cropBtn = document.getElementById('btn-crop-image');
            
            if (file) {
                image.src = URL.createObjectURL(file);
                image.style.display = 'block';
                cropBtn.style.display = 'block';
                
                if (cropper) cropper.destroy();
                
                cropper = new Cropper(image, {
                    aspectRatio: 1, // 1:1 para productos (cuadrado)
                    viewMode: 1,
                    autoCropArea: 0.8,
                });
            }
        });
        
        document.getElementById('btn-crop-image').addEventListener('click', async () => {
            if (!cropper) return;
            
            const btn = document.getElementById('btn-crop-image');
            const originalText = btn.textContent;
            btn.textContent = "Subiendo...";
            btn.disabled = true;

            cropper.getCroppedCanvas().toBlob(async (blob) => {
                if (!blob) { alert("Error al crear el blob."); btn.textContent = originalText; btn.disabled = false; return; }

                try {
                    const fileName = `${currentUser.id}/prod_${Date.now()}.png`;
                    const { error: uploadErr } = await supabase.storage.from('ecommerce-images').upload(fileName, blob, { contentType: 'image/png', upsert: true });
                    if (uploadErr) throw uploadErr;
                    
                    const { data } = supabase.storage.from('ecommerce-images').getPublicUrl(fileName);
                    mainImageUrl = data.publicUrl;

                    // Mostrar preview de la imagen principal subida
                    document.getElementById('image-to-crop').src = mainImageUrl;
                    cropper.destroy();
                    document.getElementById('image-to-crop').style.display = 'block';
                    document.getElementById('btn-crop-image').style.display = 'none';

                } catch (error) {
                    alert("Error al subir imagen: " + error.message);
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            }, 'image/png');
        });

        async function uploadGalleryImages(files) {
            if(!files || files.length === 0) return;
            const thumbsContainer = document.getElementById('gallery-thumbs');
            const originalContent = thumbsContainer.innerHTML;
            thumbsContainer.innerHTML = '<div style="color:#64748b; font-size:0.9rem;"><i class="fas fa-spinner fa-spin"></i> Subiendo...</div>';

            try {
                for (const file of files) {
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${currentUser.id}/gal_${Date.now()}.${fileExt}`;
                    const { error: uploadErr } = await supabase.storage.from('ecommerce-images').upload(fileName, file, { upsert: true });
                    if (uploadErr) throw uploadErr;

                    const { data } = supabase.storage.from('ecommerce-images').getPublicUrl(fileName);
                    galleryUrls.push(data.publicUrl);
                }
            } catch (error) {
                alert("Error al subir galería: " + error.message);
            } finally {
                renderGalleryThumbs();
            }
        }

        function renderGalleryThumbs() {
            const thumbsContainer = document.getElementById('gallery-thumbs');
            if (galleryUrls.length === 0) {
                thumbsContainer.innerHTML = '<div style="color:#94a3b8; font-size:0.9rem;">No hay imágenes.</div>';
                return;
            }
            thumbsContainer.innerHTML = galleryUrls.map((url, index) => `
                <div class="gallery-thumb">
                    <img src="${url}">
                    <button type="button" onclick="removeGalleryImage(${index})"><i class="fas fa-times"></i></button>
                </div>
            `).join('');
        }

        function removeGalleryImage(index) {
            galleryUrls.splice(index, 1);
            renderGalleryThumbs();
        }


        function openProductModal(product = null) {
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('btn-modal-delete').style.display = 'none';
            document.getElementById('image-to-crop').style.display = 'none';
            document.getElementById('btn-crop-image').style.display = 'none';
            
            if (cropper) cropper.destroy();
            cropper = null;
            mainImageUrl = '';
            galleryUrls = [];
            renderGalleryThumbs();

            if (product) {
                document.getElementById('modal-title').textContent = 'Editar Producto';
                document.getElementById('product-id').value = product.id;
                document.getElementById('prod-nombre').value = product.nombre;
                document.getElementById('prod-descripcion').value = product.descripcion || '';
                document.getElementById('prod-precio').value = product.precio;
                document.getElementById('prod-categoria').value = product.categoria || '';
                document.getElementById('prod-stock').value = product.stock || 0;
                
                if (product.imagen_url) {
                    mainImageUrl = product.imagen_url;
                    document.getElementById('image-to-crop').src = mainImageUrl;
                    document.getElementById('image-to-crop').style.display = 'block';
                }
                if (product.galeria && Array.isArray(product.galeria)) {
                    galleryUrls = [...product.galeria];
                    renderGalleryThumbs();
                }

                document.getElementById('btn-modal-save').textContent = 'Guardar Cambios';
                document.getElementById('btn-modal-delete').style.display = 'block';
            } else {
                document.getElementById('modal-title').textContent = 'Nuevo Producto';
                document.getElementById('btn-modal-save').textContent = 'Crear Producto';
            }

            document.getElementById('product-modal').classList.add('open');
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.remove('open');
            if (cropper) cropper.destroy();
            cropper = null;
        }

        async function saveProduct(e) {
            e.preventDefault();
            
            if (!mainImageUrl) { alert("Debes subir y recortar la imagen principal."); return; }
            
            const btn = document.getElementById('btn-modal-save');
            const originalText = btn.textContent;
            btn.disabled = true; btn.textContent = "Guardando...";

            const productId = document.getElementById('product-id').value;
            const productData = {
                nombre: document.getElementById('prod-nombre').value,
                descripcion: document.getElementById('prod-descripcion').value,
                precio: parseFloat(document.getElementById('prod-precio').value),
                categoria: document.getElementById('prod-categoria').value,
                stock: parseInt(document.getElementById('prod-stock').value),
                imagen_url: mainImageUrl,
                galeria: galleryUrls,
            };

            try {
                let error;
                if (productId) {
                    ({ error } = await supabase.from('productos').update(productData).eq('id', productId).eq('creado_por', currentUser.id));
                } else {
                    productData.creado_por = currentUser.id;
                    ({ error } = await supabase.from('productos').insert(productData));
                }

                if (error) throw error;
                closeProductModal();
                loadProducts();
            } catch (error) {
                alert("Error al guardar: " + error.message);
            } finally {
                btn.disabled = false; btn.textContent = originalText;
            }
        }

        async function deleteProduct() {
            if (!confirm('¿Estás seguro de eliminar este producto?')) return;
            const productId = document.getElementById('product-id').value;
            if (!productId) return;
            
            const btn = document.getElementById('btn-modal-delete');
            btn.disabled = true; btn.textContent = "Eliminando...";

            try {
                const { error } = await supabase.from('productos').delete().eq('id', productId).eq('creado_por', currentUser.id);
                if (error) throw error;
                closeProductModal();
                loadProducts();
            } catch (error) {
                alert("Error al eliminar: " + error.message);
            } finally {
                btn.disabled = false; btn.textContent = 'Eliminar Producto';
            }
        }

        async function loadProducts() {
            const list = document.getElementById('products-list');
            list.innerHTML = '<p style="text-align:center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Cargando...</p>';

            const { data, error } = await supabase.from('productos').select('*').eq('creado_por', currentUser.id).order('id', { ascending: false });

            if (error) { list.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`; return; }

            productsCache = data || [];
            
            if (productsCache.length === 0) {
                list.innerHTML = '<p style="text-align:center; padding: 20px; color: #94a3b8;">No tienes productos aún.</p>';
                return;
            }

            list.innerHTML = productsCache.map(p => `
                <div class="product-item" onclick="openProductModal(${p.id})">
                    <img src="${p.imagen_url || 'https://via.placeholder.com/60'}" alt="${p.nombre}">
                    <div class="product-info">
                        <div>${p.nombre}</div>
                        <small>$${p.precio.toFixed(2)} | ${p.categoria || 'Sin Categoría'}</small>
                    </div>
                    <div class="product-actions">
                        <button onclick="event.stopPropagation(); openProductModal(${p.id})"><i class="fas fa-edit"></i></button>
                    </div>
                </div>
            `).join('');

            updateCategoryDatalist();
        }

        function updateCategoryDatalist() {
            const rawCategories = productsCache.map(p => p.categoria).filter(c => c && c.trim() !== '');
            const uniqueCategories = [...new Set(rawCategories)];
            const datalist = document.getElementById('lista-categorias');
            datalist.innerHTML = uniqueCategories.sort().map(cat => 
                `<option value="${cat}">`
            ).join('');
        }

        // --- PEDIDOS ---
        async function loadOrders() {
            const list = document.getElementById('orders-list');
            const filter = document.getElementById('order-filter').value;
            list.innerHTML = '<p style="text-align:center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Cargando...</p>';

            let query = supabase.from('pedidos').select('*').eq('tienda_id', currentUser.id).order('created_at', { ascending: false });
            if (filter !== 'todos') query = query.eq('estado', filter);
            
            const { data: orders, error } = await query;

            if (error) { list.innerHTML = `<p style="color:red;">Error: ${error.message}</p>`; return; }

            if (orders.length === 0) {
                list.innerHTML = `<p style="text-align:center; padding: 20px; color: #94a3b8;">No hay pedidos ${filter === 'todos' ? '' : filter}s.</p>`;
                return;
            }

            const { data: clients } = await supabase.from('clientes').select('id, nombre, telefono');
            const clientMap = clients.reduce((map, c) => { map[c.id] = c; return map; }, {});

            list.innerHTML = orders.map(o => {
                const client = clientMap[o.cliente_id] || { nombre: 'Cliente Desconocido', telefono: 'N/A' };
                const items = o.productos.items.map(item => `${item.name} ($${item.price})`).join(', ');
                const statusClass = `status-${o.estado}`;

                return `
                    <div class="order-item">
                        <div class="order-header">
                            <span>#${o.id} - ${client.nombre}</span>
                            <span class="order-status ${statusClass}">${o.estado.toUpperCase()}</span>
                        </div>
                        <div style="font-size:0.9rem; color:#475569;">
                            <i class="fas fa-calendar-alt"></i> ${new Date(o.created_at).toLocaleDateString()}
                        </div>
                        <div style="font-weight:bold; margin:5px 0;">Total: $${o.total.toFixed(2)}</div>
                        <div class="order-details">
                            <i class="fas fa-box"></i> Productos: ${items}<br>
                            <i class="fas fa-phone"></i> Teléfono: <a href="https://wa.me/${client.telefono}" target="_blank">${client.telefono}</a><br>
                            <i class="fas fa-truck"></i> Envío: ${o.productos.delivery.method === 'delivery' ? o.productos.delivery.address : 'Retiro en tienda'}
                        </div>
                        <div style="margin-top:10px;">
                            <select onchange="updateOrderStatus(${o.id}, this.value)" class="login-input" style="width:150px; padding:8px;">
                                <option value="pendiente" ${o.estado === 'pendiente' ? 'selected' : ''}>Pendiente</option>
                                <option value="confirmado" ${o.estado === 'confirmado' ? 'selected' : ''}>Confirmado</option>
                                <option value="enviado" ${o.estado === 'enviado' ? 'selected' : ''}>Enviado</option>
                                <option value="cancelado" ${o.estado === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                            </select>
                            <button class="btn-action" style="width:auto; padding:8px 15px; margin-top:0; background:var(--accent);" onclick="notifyClientOrder(${o.id}, '${client.telefono}', '${o.estado}')">
                                <i class="fas fa-whatsapp"></i> Notificar
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function updateOrderStatus(orderId, newStatus) {
            const { error } = await supabase.from('pedidos').update({ estado: newStatus }).eq('id', orderId).eq('tienda_id', currentUser.id);
            if (error) alert("Error al actualizar estado: " + error.message);
            else loadOrders();
        }

        function notifyClientOrder(orderId, phone, status) {
            const messages = {
                'pendiente': `Hola! Gracias por tu pedido #${orderId}. Está en estado PENDIENTE. Por favor realiza el pago y envíanos el comprobante.`,
                'confirmado': `¡Excelente! Tu pedido #${orderId} ha sido CONFIRMADO. Estamos preparando el envío.`,
                'enviado': `¡Buenas noticias! Tu pedido #${orderId} ha sido ENVIADO. Llegará pronto.`,
                'cancelado': `Tu pedido #${orderId} ha sido CANCELADO. Contáctanos para más detalles.`
            };
            const msg = messages[status] || `Actualización del pedido #${orderId}: ${status.toUpperCase()}.`;
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // --- CHAT ---
        async function loadClients() {
            const { data: clients, error } = await supabase.from('clientes').select('id, nombre, telefono').contains('tiendas_activas', [currentUser.id]);
            if (error) return;
            
            const listContainer = document.getElementById('chat-clients-list');
            listContainer.innerHTML = '';

            // Obtener el conteo de mensajes no leídos
            const { data: unreadCounts } = await supabase
                .from('mensajes')
                .select('cliente_id, count', { count: 'exact' })
                .eq('tienda_id', currentUser.id)
                .eq('enviado_por_rol', 'cliente')
                .eq('leido_por_tienda', false);
            
            const unreadMap = unreadCounts.reduce((map, item) => {
                map[item.cliente_id] = item.count;
                return map;
            }, {});

            clients.forEach(client => {
                const unread = unreadMap[client.id] || 0;
                listContainer.innerHTML += `
                    <div class="client-item" data-client-id="${client.id}" onclick="openChatWindow('${client.id}', '${client.nombre}')">
                        <i class="fas fa-user-circle" style="font-size:2rem; color:#94a3b8;"></i>
                        <div class="client-info">
                            <div>${client.nombre}</div>
                            <small>${client.telefono}</small>
                        </div>
                        ${unread > 0 ? `<span class="unread-indicator">${unread}</span>` : ''}
                    </div>
                `;
            });
        }
        
        async function openChatWindow(clientId, clientName) {
            if (currentChatClient === clientId) return;

            // Actualizar UI
            document.querySelectorAll('.client-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.client-item[data-client-id="${clientId}"]`).classList.add('active');
            document.getElementById('chat-header-current').innerHTML = `Chat con: <b>${clientName}</b> 
                <a href="https://wa.me/${document.querySelector(`.client-item[data-client-id="${clientId}"] small`).textContent.trim()}" target="_blank" style="color:var(--btn-green);"><i class="fab fa-whatsapp"></i></a>`;
            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('chat-message-input').disabled = false;
            document.querySelector('#chat-input-form button').disabled = false;
            currentChatClient = clientId;

            // Marcar mensajes como leídos
            await supabase.from('mensajes').update({ leido_por_tienda: true }).eq('tienda_id', currentUser.id).eq('cliente_id', clientId).eq('enviado_por_rol', 'cliente');
            document.querySelector(`.client-item[data-client-id="${clientId}"] .unread-indicator`)?.remove();
            
            // Cargar mensajes
            const { data: messages, error } = await supabase.from('mensajes').select('*').eq('tienda_id', currentUser.id).eq('cliente_id', clientId).order('created_at', { ascending: true });
            if (error) return;

            messages.forEach(msg => renderChatMessage(msg, msg.enviado_por_rol === 'tienda' ? 'me' : 'client'));
            scrollToBottomChat();
            
            // Inicializar el canal de chat en tiempo real
            if (chatChannel) supabase.removeChannel(chatChannel);

            chatChannel = supabase.channel(`client-inbox-${clientId}`)
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'mensajes', filter: `tienda_id=eq.${currentUser.id},cliente_id=eq.${clientId}` }, payload => {
                    if (payload.new.enviado_por_rol === 'cliente') {
                        renderChatMessage(payload.new, 'client');
                        // Marcar como leído inmediatamente si el chat está abierto
                        supabase.from('mensajes').update({ leido_por_tienda: true }).eq('id', payload.new.id);
                    }
                }).subscribe();
        }

        function renderChatMessage(msg, className) {
            const div = document.createElement('div');
            div.className = `msg ${className}`;
            div.innerHTML = msg.contenido.replace(/\n/g, '<br>');
            document.getElementById('chat-messages').appendChild(div);
            scrollToBottomChat();
        }

        document.getElementById('chat-input-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-message-input');
            const text = input.value.trim();
            if (!text || !currentChatClient) return;

            input.value = '';
            renderChatMessage({ contenido: text }, 'me');
            
            await supabase.from('mensajes').insert({
                tienda_id: currentUser.id,
                cliente_id: currentChatClient,
                enviado_por_rol: 'tienda',
                contenido: text
            });
            
            // Broadcast para que el cliente lo reciba inmediatamente
            if(chatChannel) chatChannel.send({ type: 'broadcast', event: 'new_message', payload: { content: text } });
        });

        function scrollToBottomChat() {
            const d = document.getElementById('chat-messages'); 
            d.scrollTop = d.scrollHeight; 
        }

        // --- CONFIGURACIÓN ---
        async function loadConfig() {
            const { data } = await supabase.from('usuarios').select('*').eq('id', currentUser.id).single();
            if (!data) return;

            // CARGA NUEVO CAMPO
            document.getElementById('conf-nombre-tienda').value = data.nombre_tienda || '';
            
            document.getElementById('conf-banco').value = data.banco_nombre || '';
            document.getElementById('conf-titular').value = data.banco_titular || '';
            document.getElementById('conf-ci').value = data.banco_ci || '';
            document.getElementById('conf-numero').value = data.banco_numero || '';
            if(data.banco_tipo) document.getElementById('conf-tipo').value = data.banco_tipo;
            if (data.qr_imagen_url) { document.getElementById('qr-preview').src = data.qr_imagen_url; document.getElementById('qr-preview').style.display = 'block'; }
            if(data.logo_url) updateAdminLogoUI(data.logo_url);
            if(data.slug) document.getElementById('conf-alias').value = data.slug;
            document.getElementById('alias-display').textContent = data.slug || '[Aún no definido]';

            // Actualizar título de la tienda en el encabezado
            document.getElementById('store-title').textContent = data.nombre_tienda || 'Admin Panel';
        }

        // Subida de QR
        document.getElementById('qr-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const preview = document.getElementById('qr-preview');
            preview.src = URL.createObjectURL(file);
            preview.style.display = 'block';
            
            const btn = document.getElementById('btn-save-config');
            const originalText = btn.textContent;
            btn.textContent = "Subiendo QR...";
            btn.disabled = true;

            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `${currentUser.id}/qr.${fileExt}`;
                const { error: uploadErr } = await supabase.storage.from('ecommerce-images').upload(fileName, file, { upsert: true });
                if (uploadErr) throw uploadErr;
                
                const { data } = supabase.storage.from('ecommerce-images').getPublicUrl(fileName);
                
                const { error: updateErr } = await supabase.from('usuarios').update({ qr_imagen_url: data.publicUrl }).eq('id', currentUser.id);
                if (updateErr) throw updateErr;

                alert("QR actualizado.");

            } catch (error) {
                alert("Error al subir QR: " + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });

        // Subida de Logo (similar a QR, no necesita cropper en este ejemplo, solo carga y muestra)
        document.getElementById('logo-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const btn = document.getElementById('btn-save-config');
            const originalText = btn.textContent;
            btn.textContent = "Subiendo Logo...";
            btn.disabled = true;

            try {
                const fileExt = file.name.split('.').pop();
                const fileName = `${currentUser.id}/logo.${fileExt}`;
                const { error: uploadErr } = await supabase.storage.from('ecommerce-images').upload(fileName, file, { upsert: true });
                if (uploadErr) throw uploadErr;
                
                const { data } = supabase.storage.from('ecommerce-images').getPublicUrl(fileName);
                
                const { error: updateErr } = await supabase.from('usuarios').update({ logo_url: data.publicUrl }).eq('id', currentUser.id);
                if (updateErr) throw updateErr;

                updateAdminLogoUI(data.publicUrl);
                alert("Logo actualizado.");

            } catch (error) {
                alert("Error al subir Logo: " + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });

        function updateAdminLogoUI(url) {
            document.getElementById('logo-preview').src = url;
            document.getElementById('logo-preview').style.display = 'block';
            document.getElementById('logo-placeholder').style.display = 'none';
        }

        async function saveConfig(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-save-config');
            btn.textContent = "Guardando...";
            btn.disabled = true;

            // NUEVO: Obtener el nombre de la tienda
            const nombreTienda = document.getElementById('conf-nombre-tienda').value.trim();
            
            const alias = document.getElementById('conf-alias').value.trim();
            const titular = document.getElementById('conf-titular').value.trim();
            const banco = document.getElementById('conf-banco').value.trim();
            const ci = document.getElementById('conf-ci').value.trim();
            const numero = document.getElementById('conf-numero').value.trim();
            const tipo = document.getElementById('conf-tipo').value;

            try {
                const updates = {
                    // NUEVO: Añadir nombre de la tienda
                    nombre_tienda: nombreTienda, 
                    
                    slug: alias,
                    banco_nombre: banco,
                    banco_titular: titular,
                    banco_ci: ci,
                    banco_numero: numero,
                    banco_tipo: tipo,
                    // qr_imagen_url se actualiza aparte en la función de subida
                };

                const { error } = await supabase.from('usuarios').update(updates).eq('id', currentUser.id);
                if (error) throw error;
                
                // Actualizar UI
                document.getElementById('store-title').textContent = nombreTienda;
                document.getElementById('alias-display').textContent = alias;
                
                alert("Configuración guardada exitosamente.");
            } catch (error) {
                alert("Error al guardar: " + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = "Guardar Configuración";
            }
        }
    </script>
</body>
</html>
